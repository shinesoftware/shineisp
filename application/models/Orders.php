<?php

/**
 * Orders
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ShineISP
 * 
 * @author     Shine Software <info@shineisp.com>
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class Orders extends BaseOrders {
	
	static protected $order = NULL;

	public static $events;
	
	/**
	 * @return the $order
	 */
	public static function getOrder() {
		return Orders::$order;
	}

	/**
	 * @param NULL $order
	 */
	public static function setOrder($order) {
		Orders::$order = $order;
		return $this;
	}

	/**
	 * Event Manager Registration
	 * @return mixed
	 */
	public static function events()
	{
		$em = Shineisp_Registry::get('em');
		if (!self::$events && is_object($em)) {
			self::$events = Shineisp_Registry::get('em');
		}
	
		return self::$events;
	}
	
	/**
	 * Prepare the DQL query for the module
	 */
	public static function getDQL(){
	    $doctrine = Doctrine_Query::create ()->from ( 'Orders o' )
    										->leftJoin ( 'o.Isp i' )
											->leftJoin ( 'o.Invoices in' )
											->leftJoin ( 'o.OrdersItems oi' )
											->leftJoin ( 'oi.BillingCycle bc' )
											->leftJoin ( 'o.OrdersItemsDomains oid' )
											->leftJoin ( 'oid.Domains d' )
											->leftJoin ( 'd.DomainsTlds tld' )
											->leftJoin ( 'tld.WhoisServers w' )
											->leftJoin ( 'oi.Products p' )
											->leftJoin ( 'p.Taxes t' )
											->leftJoin ( 'o.Customers c' )
											->leftJoin ( 'o.Customers r' )
											->leftJoin ( 'c.Addresses a' )
											->leftJoin ( 'a.Countries co' )
											->leftJoin ( 'o.Statuses s' );
	    
	    return $doctrine;
	}
	
	public static function grid($rowNum = 10) {
		
		$translator = Shineisp_Registry::getInstance ()->Zend_Translate;
		
		$columns [] = array ('label' => null, 'field' => 'o.order_id', 'alias' => 'order_id', 'type' => 'selectall', 'attributes' => array ('width' => 20 ) );
		$columns [] = array ('label' => $translator->translate ( 'ID' ), 'field' => 'o.order_id', 'alias' => 'order_id', 'type' => 'integer', 'sortable' => true, 'attributes' => array ('width' => 30 ), 'searchable' => true );
		$columns [] = array ('label' => $translator->translate ( 'Number' ), 'field' => 'o.order_number', 'alias' => 'order_number', 'type' => 'string', 'sortable' => true, 'attributes' => array ('class' => 'visible-lg', 'width' => 100 ), 'searchable' => true );
		$columns [] = array ('label' => $translator->translate ( 'Invoice' ), 'field' => 'in.formatted_number', 'alias' => 'formatted_number', 'type' => 'integer', 'sortable' => true, 'attributes' => array ('class' => 'visible-lg hidden-md hidden-xs', 'width' => 50 ), 'searchable' => true );
		$columns [] = array ('label' => $translator->translate ( 'Date' ), 'field' => 'o.order_date', 'alias' => 'orderdate', 'type' => 'date', 'sortable' => true, 'attributes' => array ('class' => 'visible-lg visible-md hidden-xs', 'width' => 70 ), 'searchable' => true );
		
		$columns [] = array ('label' => $translator->translate ( 'Company' ), 'field' => "CONCAT(c.firstname, ' ', c.lastname, ' ', c.company)", 'alias' => 'customer', 'sortable' => true, 'searchable' => true, 'attributes' => array ('class' => 'visible-lg'), 'type' => 'string');
		$columns [] = array ('label' => $translator->translate ( 'Reseller' ), 'field' => "CONCAT(r.company, ' ', r.firstname,' ', r.lastname)", 'alias' => 'reseller', 'sortable' => true, 'searchable' => true, 'attributes' => array ('class' => 'visible-lg hidden-md hidden-xs'), 'type' => 'string');
		
		$columns [] = array ('label' => $translator->translate ( 'Total' ), 'field' => 'o.total', 'alias' => 'total', 'sortable' => true, 'type' => 'float', 'attributes' => array ('class' => 'visible-lg hidden-md hidden-xs') );
		$columns [] = array ('label' => $translator->translate ( 'VAT' ), 'field' => 'o.vat', 'alias' => 'vat', 'sortable' => true, 'type' => 'float', 'attributes' => array ('class' => 'visible-lg hidden-md hidden-xs') );
		$columns [] = array ('label' => $translator->translate ( 'Grand Total' ), 'field' => 'o.grandtotal', 'alias' => 'grandtotal', 'sortable' => true, 'type' => 'float', 'attributes' => array ('class' => 'visible-lg visible-md hidden-xs') );
		$columns [] = array ('label' => $translator->translate ( 'Profit' ), 'field' => '(o.total - o.cost)', 'alias' => 'profit', 'sortable' => true, 'type' => 'float', 'attributes' => array ('class' => 'visible-lg visible-md hidden-xs') );
		$columns [] = array ('label' => $translator->translate ( 'Renewal' ), 'field' => 'o.is_renewal', 'alias' => 'is_renewal', 'sortable' => true, 'type' => 'boolean', 'searchable' => true, 'filterdata' => array( '0'=>'No', '1'=>'Yes'), 'attributes' => array ('class' => 'visible-lg hidden-md hidden-xs', 'width' => 30 ));
		$columns [] = array ('label' => $translator->translate ( 'Statuses' ), 'field' => 's.status', 'alias' => 'status', 'sortable' => true, 'searchable' => true, 'type' => 'index', 'attributes' => array ('class' => 'visible-lg visible-md hidden-xs', 'width' => 70 ));
		
		
		$config ['datagrid'] ['columns'] = $columns;
		$config ['datagrid'] ['fields'] = "o.order_id,
											  o.order_number,
                                              DATE_FORMAT(o.order_date, '".Settings::getMySQLDateFormat('dateformat')."') as orderdate, 
                                              o.is_renewal as is_renewal,
                                              o.total as total,
                                              o.vat as vat,
                                              o.grandtotal as grandtotal,
                                              o.total - o.cost as profit,
                                              in.formatted_number as formatted_number,
                                              CONCAT(c.firstname, ' ', c.lastname, ' ', c.company) as customer,
                                              CONCAT(r.company, ' ', r.firstname,' ', r.lastname) as reseller,
                                              s.status as status";
		
		$config ['datagrid'] ['dqrecordset'] = self::getDQL()->select ( $config ['datagrid'] ['fields'] )->orderBy('order_date desc');
		
		$config ['datagrid'] ['rownum'] = $rowNum;
		$config ['datagrid'] ['basepath'] = "/admin/orders/";
		$config ['datagrid'] ['index'] = "order_id";
		$config ['datagrid'] ['rowlist'] = array ('10', '50', '100', '1000' );
		
		$config ['datagrid'] ['buttons'] ['edit'] ['label'] = $translator->translate ( 'Edit' );
		$config ['datagrid'] ['buttons'] ['edit'] ['cssicon'] = "edit";
		$config ['datagrid'] ['buttons'] ['edit'] ['action'] = "/admin/orders/edit/id/%d";
		
		$config ['datagrid'] ['buttons'] ['delete'] ['label'] = $translator->translate ( 'Delete' );
		$config ['datagrid'] ['buttons'] ['delete'] ['cssicon'] = "delete";
		$config ['datagrid'] ['buttons'] ['delete'] ['action'] = "/admin/orders/delete/id/%d";
		$config ['datagrid'] ['massactions']['commons'] = array ('bulk_delete'=>'Mass Delete', 'bulk_export'=>'Export List');
		return $config;
	}
	
	/**
	 * delete the customer selected 
	 * @param array
	 * @return Boolean
	 */
	public static function massdelete($orders) {
		try{
			foreach ($orders as $orderid){
				self::DeleteByID($orderid);
			}
			
			return true;
		}catch (Exception $e){
			return false;
		}
	}
	
	/**
	 * Set a new status of all items selected
	 * @param $items
	 * @return void
	 */
	public static function setNewStatus($items) {
		$request = Zend_Controller_Front::getInstance ()->getRequest ();
		if(!empty($request)){
			$status = $request->getParams ( 'params' );
			$params = parse_str ( $status ['params'], $output );
			$status = $output ['status'];
			if (is_array ( $items ) && is_numeric ( $status )) {
				foreach ( $items as $index ) {
					if (is_numeric ( $index )) {
						self::set_status ( $index, $status );
					}
				}
				return true;
			}
		}
		return false;
	}
	
	/** 
	 * logStatusChange
	 * Log any status change for an order
	 */
	public static function logStatusChange($orderId, $statusId) {
		$orderId  = intval($orderId);
		$statusId = intval($statusId);
		
		if( !$orderId || !$statusId ) {
			return false;
		}
		
		// If we have to notify customer, let's do here
		$notify_status_change = (int)Settings::findbyParam('notify_status_change');
		if ( $notify_status_change == 1 ) {
			$orderInfo  = self::getAllInfo($orderId,'*', true);
			$orderInfo  = array_shift($orderInfo);
			$new_status = Statuses::getLabel($statusId);

			Shineisp_Commons_Utilities::sendEmailTemplate($orderInfo['Customers']['email'], 'order_status_changed', array(
				 'orderid'    => $orderInfo['order_number']
				,'new_status' => $new_status
				,':shineisp:' => array_merge($orderInfo['Customers'],$orderInfo) 
			), null, null, null, null, $orderInfo['Customers']['language_id']);
		}
				
		// Log to database	
		StatusHistory::insert($orderId, $statusId);
	} 
	
	/**
	 * setStatus
	 * Set a record with a status
	 * @param $id, $status
	 * @return Void
	 */
	public static function set_status($id, $status = null) {
		if ( empty($status) ) {
			return false;
		}
		
		$affectedRows = Doctrine_Query::create ()->update ( 'Orders o' )
									->set ( 'o.status_id', $status )
									->where('o.order_id = ?', $id)
									->execute ();
							
		if ( $affectedRows > 0 ) {
			// Log status change
			self::logStatusChange($id, $status);
		}		
		
		return $affectedRows;
	}
	
	/**
	 * setStatus
	 * Set a record with a status
	 * @param $id, $status
	 * @return Void
	 */
	public static function setInvoice($id, $invoiceID) {
		try {
			$q = Doctrine_Query::create ()->update ( 'Orders' )->set ( 'invoice_id', $invoiceID )->where ( 'order_id = ' . $id );
			return $q->execute ();
		} catch ( Exception $e ) {
			echo $e->getMessage ();
			die ();
		}
	}
	
	
	/**
	 * Get records the orders from the DB
	 * 
	 * @param $currentPage
	 * @param $rowNum
	 * @param $sort
	 * @param $where
	 * @return array
	 */
	public static function findAll($fields = "*", $currentPage = 1, $rowNum = 2, array $sort = array(), array $where = array()) {
		
		$module = Zend_Controller_Front::getInstance ()->getRequest ()->getModuleName ();
		$controller = Zend_Controller_Front::getInstance ()->getRequest ()->getControllerName ();
		
		// Defining the url sort
		$uri = isset ( $sort [1] ) ? "/sort/$sort[1]" : "";
		$dq = self::getDQL()->select ( $fields )->orderBy ( 'order_date desc' );
		
		$pagerLayout = new Doctrine_Pager_Layout ( new Doctrine_Pager ( $dq, $currentPage, $rowNum ), new Doctrine_Pager_Range_Sliding ( array ('chunk' => 10 ) ), "/$module/$controller/list/page/{%page_number}" . $uri );
		
		// Get the pager object
		$pager = $pagerLayout->getPager ();
		
		// Set the Order criteria
		if (isset ( $sort [0] )) {
			$pager->getQuery ()->orderBy ( $sort [0] );
		}
		
		if (isset ( $where ) && is_array ( $where )) {
			foreach ( $where as $filters ) {
				if (isset ( $filters [0] ) && is_array ( $filters [0] )) {
					foreach ( $filters as $filter ) {
						$method = $filter ['method'];
						$value = $filter ['value'];
						$criteria = $filter ['criteria'];
						$pager->getQuery ()->$method ( $criteria, $value );
					}
				} else {
					$method = $filters ['method'];
					$value = $filters ['value'];
					$criteria = $filters ['criteria'];
					$pager->getQuery ()->$method ( $criteria, $value );
				}
			}
		}
		
		$pagerLayout->setTemplate ( '<li><a href="{%url}">{%page}</a></li>' );
		$pagerLayout->setSelectedTemplate ( '<li class="active"><a href="{%url}">{%page}</a></li>' );
		
		$orders = $pagerLayout->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
		$pagination = $pagerLayout->display ( null, true );
		return array ('records' => $orders, 'pagination' => $pagination, 'pager' => $pager, 'recordcount' => $dq->count () );
	
	}	
	
	
	/**
	 * Get all the orders by customer_id and parent_id
	 * @param $id
	 * @return Void
	 */
	public static function getOrdersByCustomerID($id, $fields="*") {
		try {
			$arrOrders = self::getDQL()->select ( $fields )
										->where('c.customer_id = ? OR r.customer_id = ?', array($id, $id))
										->andWhere('c.isp_id = ?', Isp::getCurrentId())
										->orderBy ( 'order_date desc' )
										->execute (array (), Doctrine_Core::HYDRATE_ARRAY);
				
			if ( is_array($arrOrders) && count($arrOrders) > 0 ) {
				foreach ( $arrOrders as $k => $arrOrder ) {
					if ( !isset($arrOrder['order_number']) && isset($arrOrder['order_id']) ) {
						$arrOrders[$k]['order_number'] = self::formatOrderId($id);
					}	
				}
			}
										
			return $arrOrders;
		} catch ( Exception $e ) {
			echo $e->getMessage ();
			die ();
		}
	}
	
	/*
	 * Get all the details from a order
	 */
	public static function getOrdersDetailsByCustomerID($id) {
		$id = intval($id);
		
		$dq = Doctrine_Query::create ()->select ( "
		             o.order_id AS order_id,
                     oid.relationship_id, 
                     dm.domain_id, 
                     dt.tld_id,
                     ws.tld,
                     CONCAT(dm.domain, '.',ws.tld) as domain, 
                     d.quantity, 
                     d.description, 
                     d.price as price, 
                     d.setupfee as setupfee, 
                     t.percentage as taxpercentage,
                     DATE_FORMAT(d.date_start, '".Settings::getMySQLDateFormat('dateformat')."') as start, 
                     DATE_FORMAT(d.date_end, '".Settings::getMySQLDateFormat('dateformat')."') as end,
                     d.setup" )
		->from ( 'OrdersItems d' )
		->leftJoin ( 'd.Orders o' )
		->leftJoin ( 'd.OrdersItemsDomains oid ON d.detail_id = oid.orderitem_id' )
		->leftJoin ( 'oid.Domains dm' )
		->leftJoin ( 'd.Products p' )
		->leftJoin ( 'dm.DomainsTlds dt' )
		->leftJoin ( 'dt.WhoisServers ws' )
		->leftJoin ( 'p.Taxes t' )
		->leftJoin ( 'o.Customers c' )
		->leftJoin ( 'c.Customers r' )
		->leftJoin ( 'd.Statuses s' )
		->where('c.customer_id = ? OR r.customer_id = ?', array($id, $id));
		$rs = $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
		
		return $rs;
	}
	
	
	/**
	 * Upload document files
	 */
	public static function UploadDocument($id, $data){
		try{
	
			$attachment = new Zend_File_Transfer_Adapter_Http();
	
			$files = $attachment->getFileInfo();
				
			// Create the directory
			@mkdir ( PUBLIC_PATH . "/documents/customers/".$data['customer_id']."/orders/$id/", 0777, true );
				
			// Set the destination directory
			$attachment->setDestination ( PUBLIC_PATH . "/documents/customers/".$data['customer_id']."/orders/$id/" );
				
			if ($attachment->receive()) {
				return Files::saveit($files['attachments']['name'], "/documents/customers/".$data['customer_id']."/orders/$id/", 'orders', $id, $data['filecategory']);
			}
				
		}catch (Exception $e){
			echo $e->getMessage();
			die;
		}
	}
	
	/**
	 * saveAll
	 * Save all the data in the database
	 * @param array $params
	 * @param integer $id
	 */
	public static function saveAll($params, $id="") {
		$orders     = new Orders();
		$translator = Shineisp_Registry::getInstance ()->Zend_Translate;
		$currentStatus = "";
		
		try{
			// Set the new values
			if (is_numeric ( $id )) {
				$orders        = Doctrine::getTable ( 'Orders' )->find ( $id );
				$currentStatus = $orders->status_id; // used to detect status changes
			}
			
			if(!empty($params) && is_array($params)){
				
				$params ['date_start'] = ! empty ( $params ['date_start'] ) ? $params ['date_start'] : new Zend_Date();
				$params ['order_date'] = ! empty ( $params ['order_date'] ) ? $params ['order_date'] : new Zend_Date();
				
				$customer = Customers::getAllInfo($params ['customer_id']);
				$isp_id   = $customer['isp_id'];
				
				$orders->order_date    = Shineisp_Commons_Utilities::formatDateIn ( $params ['order_date'] );
				$orders->customer_id   = $params ['customer_id'];
				$orders->isp_id        = $isp_id;
				$orders->status_id     = $params['status_id'];
				$orders->invoice_id    = ! empty ( $params ['invoice_id'] ) ? $params ['invoice_id'] : null;
				$orders->note          = $params ['note'];
				$orders->is_renewal    = $params ['is_renewal'] == 1 ? 1 : 0;
				$orders->expiring_date = Shineisp_Commons_Utilities::formatDateIn ($params ['expiring_date']);
				$orders->vat           = $params ['vat'];
				$orders->total         = $params ['total'];
				$orders->grandtotal    = $params ['total'] + $params ['vat']; 
				
				// Save the data
				$orders->save ();
				$id = is_numeric ( $id ) ? $id : $orders->getIncremented ();
				
				// Status changed? Let's call set_status. This is needed to properly log all status change.
				if ( isset($params ['status_id']) && $params ['status_id'] != $currentStatus ) {
					self::logStatusChange($id, $params['status_id']);	
				}				
				
				// Add a fastlink to a order
				$link_exist = Fastlinks::findlinks ( $id, 'orders' );
				$link = new Fastlinks ();
				
				if (count ( $link_exist ) == 0) {
					$link->controller  = "orders";
					$link->action      = "edit";
					$link->params      = json_encode ( array ('id' => $id ) );
					$link->customer_id = $params ['customer_id'];
					$link->sqltable    = "orders";
					$link->id          = $id;
					$link->code        = Shineisp_Commons_Utilities::GenerateRandomString ();
				} else {
					$link = Doctrine::getTable ( 'Fastlinks' )->find ( $link_exist [0] ['fastlink_id'] );
					$link->code = $params ['fastlink'];
				}
				$link->save ();
				
				// Save the message note and send an alert
				if (! empty ( $params ['message'] )) {
					$order  = self::getAllInfo ( $id, null, true );
					$link   = Fastlinks::findlinks ( $id, $params ['customer_id'], 'orders' );
					$isp    = Isp::find($isp_id);
					
					$retval = Shineisp_Commons_Utilities::getEmailTemplate ( 'order_message' );
					
					if ($retval) {
						$in_reply_to = md5($id);
						
						// Save the message written by the ISP owner
						Messages::addMessage($params ['message'], null, null, $id, null, $isp_id);

						// Create the array with all the placeholders 
						$placeholders['fullname'] = $order [0] ['Customers'] ['firstname'] . " " . $order [0] ['Customers'] ['lastname'];
						$placeholders['url'] = "http://" . $_SERVER ['HTTP_HOST'] . "/index/link/id/" . $link [0] ['code'];
						$placeholders['orderid'] = sprintf ( "%03s", $id ) . " - " . Shineisp_Commons_Utilities::formatDateOut ( $order [0] ['order_date'] );
						$placeholders['messagetype'] = $translator->translate('Order Details');
						$placeholders['message'] = $params ['message'];
					
						Shineisp_Commons_Utilities::sendEmailTemplate(Contacts::getEmails($order [0] ['Customers'] ['customer_id']), 'order_message', $placeholders, $in_reply_to, null, null, null, $order [0] ['Customers'] ['language_id']);
						
						// Change the URL for the administrator
						$placeholders['url'] = "http://" . $_SERVER ['HTTP_HOST'] . "/admin/login/link/id/" . $link [0] ['code'] . "/keypass/" . Shineisp_Commons_Hasher::hash_string($isp->email);
						
						// Send a message to the administrator
						Shineisp_Commons_Utilities::sendEmailTemplate($isp->email, 'order_message_admin', $placeholders, $in_reply_to);
					}
				
				}
				
				// Saving the domain 
				if (! empty ( $params ['domains_selected'] )) {
					self::SaveDomainsDetails ( $params, $id );
				} else {

					if (! empty ( $params ['products'] )) {
						$date_end = null;
						
						// Get the product information
						$product = Products::getAllInfo($params ['products']);
						
						// Manage the details of the order
						if(!empty($params ['billingcycle_id'])){
							$months = BillingCycle::getMonthsNumber ( $params ['billingcycle_id'] );

							// Add months to the starting date 
							if ($months > 0) {
								$params ['date_end'] = Shineisp_Commons_Utilities::add_date ( $params ['date_start'], null, $months );
							}
							
						}
						
						// Format the dates before to save them in the database
						$params ['date_end'] = Shineisp_Commons_Utilities::formatDateIn ( $params ['date_end'] );
						$params ['date_start'] = Shineisp_Commons_Utilities::formatDateIn ( $params ['date_start'] );


						if(!empty($product['Taxes']['tax_id'])){
						    $vat = ($params ['price'] * $product['Taxes']['percentage']) / 100;
						    $subtotal = ($params ['price'] * ($product['Taxes']['percentage'] + 100) / 100);
						    $percentage = $product['Taxes']['percentage'];
						}else{
						    $vat = 0;
						    $subtotal = $params ['price'];
						    $percentage = 0;
						}
							
						
						$details = new OrdersItems ();
						$details->order_id = $id;
						$details->quantity = $params ['quantity'];
						$details->cost = Products::getCost($params ['products']);
						$details->price = $params ['price'];
						$details->date_start = $params ['date_start'];
						$details->date_end = $params ['date_end'];
						$details->billing_cycle_id = !empty($params ['billingcycle_id']) ? $params ['billingcycle_id'] : null;
						$details->product_id = $params ['products'];
						$details->description = $params ['description'];
						$details->status_id = $params ['status_id'];
						$details->vat = $vat;
						$details->percentage = $percentage;
						$details->subtotal = $subtotal;
						
						if ($product['type'] =="hosting"){
							// Get all the product attributes
							$attrs = ProductsAttributes::getAttributebyProductID($params ['products']);

							// Create the system attributes parameters
							foreach ($attrs as $attr) {
								if($attr['system'] && !empty($attr['ProductsAttributesIndexes'][0]['value'])){
									$hostingplan[$attr['code']] = $attr['ProductsAttributesIndexes'][0]['value'];
								}
							}
							$details->parameters = json_encode ( $hostingplan );
						}
						
						$details->save ();
						$detail_id = $details->getIncremented ();
						
						// Attaching of the service a particular domain. It's not a mandatory field because the services and the products can be bought also without a domain 
						if (is_numeric ( $params ['referdomain'] ) && $params ['referdomain'] > 0) {
							$ordersitemsdomains = new OrdersItemsDomains ();
							$ordersitemsdomains->domain_id = $params ['referdomain'];
							$ordersitemsdomains->order_id = $id;
							$ordersitemsdomains->orderitem_id = $detail_id;
							$ordersitemsdomains->save ();
						}
					}
				}
				
				// Handle the payment transaction
				if ( !empty($params ['paymentdate'])) {
					Payments::addPayment($id, $params ['reference'], $params ['bank_id'], $params ['confirmed'], $params['income'], $params ['paymentdate'], $params ['customer_id'], $params ['payment_description']);
				}
				
				// Set the status of the order
				OrdersItems::setNewStatus ( $id, $params ['status_id'] );
				
				// Update the totals of the order selected
				self::updateTotalsOrder ( $id );
				
				return $id;
			}
		
		} catch ( Exception $e ) {
			die($e->getMessage());
		}
		
		return false;
	}

	private static function SaveDomainsDetails($params, $orderid) {
		$i = 0;
		try {
			if (is_array ( $params )) {
				
			    // Get the Billing Cycle information
			    if(!empty($params ['billingcycle_id'])){
				    $months = BillingCycle::getMonthsNumber ( $params ['billingcycle_id'] );
			    }else{
			        $bc = BillingCycle::getDefaultDomainBillingCycle ();
			        $params ['billingcycle_id'] = $bc['billing_cycle_id'];
			        $months = $bc['months'];
			    }

			    // Convert the domain selection into an array
				$params ['domains_selected'] = explode(",", $params ['domains_selected']);

				foreach ( $params ['domains_selected'] as $domain_id ) {
					
					// Get the domain information
				    $domain = Domains::getAllInfo($domain_id, null, "*", true);

				    // Get the taxes information
					$tax = Taxes::getTaxbyTldID($domain[0]['tld_id']);
					
					// Get the price of the product selected
					$product = $domain[0]['DomainsTlds'];
					
					// Domain name
					$domain = $domain [0] ['domain'] . "." . $domain [0] ['DomainsTlds'] ['WhoisServers']['tld'];
					
					if(!empty($product['tax_id'])){
					    $vat = ($product ['registration_price'] * $tax['percentage']) / 100;
					    $subtotal = ($product ['registration_price'] * ($tax['percentage'] + 100) / 100);
					    $percentage = $tax['percentage'];
					}else{
					    $vat = 0;
					    $subtotal = $product ['registration_price'];
					    $percentage = 0;
					}
					
					// Adding the domain in the order selected
					$details = new OrdersItems ();
					$details->order_id = $orderid;
					$details->quantity = $params ['quantity'];
					$details->price = $product ['registration_price'];
					$details->vat = $vat;
					$details->percentage = $percentage;
					$details->subtotal = $subtotal;
					$details->cost = $product ['registration_cost'];
					$details->date_start = Shineisp_Commons_Utilities::formatDateIn ( $params ['date_start'] );
					$details->date_end = Shineisp_Commons_Utilities::formatDateIn ( $params ['date_start']->add($months, Zend_Date::MONTH) );
					$details->billing_cycle_id = $params ['billingcycle_id'];
					$details->tld_id = $product ['tld_id'];
					$details->description = $domain;
					
					// Register the domain paramenter registration
					$details->parameters = json_encode ( array ('domain' => array('name' => $domain, 'tld' => $product ['tld_id'], 'action' => 'registerDomain', 'authcode' => null)));
					
					$details->save ();
					$orderitem_id = $details->getIncremented ();
					unset ( $details );
					
					// Set the domain properties
					$domain = Doctrine::getTable ( 'Domains' )->find ( $domain_id );
					$domain->orderitem_id = $orderitem_id;
					$domain->customer_id = $params ['customer_id'];
					$domain->save ();
					unset ( $domain );
					unset ( $product );
					$i ++;
				
				}
			}
		} catch ( Exception $e ) {
			die ( $e->getMessage () );
		}
	}
		
	
	/*
	 * cloneOrder
	 * Clone a order using its id
	 */
	public static function cloneOrder($idorder, $note = "", $sendemail=false) {
		
		if (! is_numeric ( $idorder )) {
			return false;
		}
		
		$oldOrder = self::find ( $idorder )->toArray ();
		$oldOrderDetails = OrdersItems::getAllDetails ( $idorder, null, true );
		
		$order = new Orders ();
		
		try {
			$order->customer_id = $oldOrder ['customer_id'];
			$order->isp_id = $oldOrder ['isp_id'];
			$order->order_date = date ( 'Y-m-d H:i:s' );
			$order->status_id = 9; // To be pay
			$order->total = $oldOrder ['total'];
			$order->vat = $oldOrder ['vat'];
			$order->grandtotal = $oldOrder ['grandtotal'];
			$order->note = $note;
			$order->save ();
			$id = $order->getIncremented ();
			
			foreach ( $oldOrderDetails as $details ) {
				
				$orderitem = new OrdersItems ();
			
				$isDomain = Products::CheckIfProductIsTLDDomain ( $details ['product_id'] );
				
				if ($details['Products']['type'] == "domain") {
					$orderitem->parameters = json_encode ( array ('domain' => $oldOrderDetails [0] ['description'], 'action' => 'renewDomain' ) );
				}
				
				$date_end = Shineisp_Commons_Utilities::add_date ( date ( $oldOrderDetails [0] ['date_end'] ), null, BillingCycle::getMonthsNumber ( $oldOrderDetails [0] ['billing_cycle_id'] ) * $oldOrderDetails [0] ['quantity'] );
				$orderitem->date_start = $oldOrderDetails [0] ['date_end']; // The new order will have the date_end as date_start
				$orderitem->date_end = Shineisp_Commons_Utilities::formatDateIn ($date_end);

				// Get the number of the months to be sum to the expiration date of the domain
				$parameters = json_decode($details ['parameters'], true);
				$tldid = !empty($parameters['tld']) ? $parameters['tld'] : NULL;
				$domain = !empty($parameters['domain']) ? $parameters['domain'] : NULL;
					
				// get the tld information
				$arrdomain = Shineisp_Commons_Utilities::getTld($domain);
				if(!empty($arrdomain[1])){
					$tld = DomainsTlds::getbyTld($arrdomain[1]);
					if(!empty($tld['tld_id'])){
						$orderitem->tld_id = $tld['tld_id'];
					}
				}
				
				$orderitem->order_id = $id;
				$orderitem->product_id = $details ['product_id'];
				$orderitem->billing_cycle_id = $details ['billing_cycle_id'];
				$orderitem->autorenew = $details ['autorenew'];
				$orderitem->description = $details ['description'];
				$orderitem->quantity = $details ['quantity'];
				$orderitem->price = $details ['price'];
				$orderitem->cost = $details ['cost'];
				$orderitem->status_id = Statuses::id("processing", "orders"); // Processing status set
				
				if($orderitem->trySave ()){
					$detailid = $orderitem->getIncremented ();
					
					// If the product type is a service we have to add a record in the Orders_items_domains table
					// in order to join the domain with the service/order item
					if (! $isDomain) {
						$oldOID = OrdersItemsDomains::findIDsByOrderItemID ( $details ['detail_id'], 'domain_id', true );
						if (! empty ( $oldOID [0] ['domain_id'] ) && is_numeric ( $oldOID [0] ['domain_id'] )) {
							$ordersitemsdomains = new OrdersItemsDomains ();
							$ordersitemsdomains->domain_id = $oldOID [0] ['domain_id'];
							$ordersitemsdomains->order_id = $id;
							$ordersitemsdomains->orderitem_id = $detailid;
							$ordersitemsdomains->save ();
							Domains::setStatus ( $oldOID [0] ['domain_id'], Statuses::id("processing", "domains") ); // Set the domains status as processing
							Domains::setExpirationDate ( $oldOID [0] ['domain_id'], Shineisp_Commons_Utilities::formatDateIn ($date_end) ); // Set the new expiration date
						}
					}
					unset ( $orderitem );
				}
			}
			
			// Update Order
			self::updateTotalsOrder($id);
			
			// Send the email confirmation
			if($sendemail){
				self::sendOrder($id);
			}
			
			return $id;
		
		} catch ( Exception $e ) {
			echo $e->getMessage ();
			die ();
		}
		return true;
	}
	
	/*
	 * checkAutorenewProducts
	 * Check if within the list of products exist at least one service/domain set as Autorenewable.
	 * @return boolean
	 */
	private static function checkAutorenewProducts($products) {
		foreach ( $products as $product ) {
			if($product['renew']){
				return true;
			}	
		}
		return false;
	}
	
	/**
	 * renewOrder
	 * Renew of Order 
	 * @return orderid integer
	 */
	public static function renewOrder($customer_id, $products) {
		$order = new Orders ();
		$i     = 0;
		$total = 0;
		$vat   = 0;
		$tldid = null;
		
		// Check if there are auto-renewal services/products
		if (! self::checkAutorenewProducts ( $products )) {
			return false;
		}
		
		if (is_numeric ( $customer_id )) {
			
			$customer = Customers::getAllInfo($customer_id);
			
			if (count ( $products ) > 0) {
				
				$order->customer_id = $customer_id;
				$order->isp_id      = $customer ['isp_id'];
				$order->is_renewal  = true;
				$order->order_date  = date ( 'Y-m-d' );
				$order->status_id   = Statuses::id("tobepaid", "orders"); // To be paid
				$order->uuid        = Shineisp_Commons_Uuid::generate();
				$order->save();
			
				// Create the public number but I need the order id
				$order->order_number = self::formatOrderId($order->getIncremented());
				$order->save();				

				// Get the generated order id
				$orderid = $order->getIncremented ();
				
				// Log data 
				Shineisp_Commons_Utilities::log("A new renewal order (" . $order->order_number . ") for ".$customer['fullname']." has been created successfully");
				
				// Add a fastlink to a order
				$link_exist = Fastlinks::findlinks ( $orderid, $customer_id, 'orders' );
				if (count ( $link_exist ) == 0) {
					$link = new Fastlinks ();
					$link->controller  = "orders";
					$link->action      = "edit";
					$link->params      = json_encode ( array ('id' => $orderid ) );
					$link->customer_id = $customer_id;
					$link->sqltable    = "orders";
					$link->id          = $orderid;
					$link->code        = Shineisp_Commons_Utilities::GenerateRandomString ();
					$link->save ();
				}
				
				if (count ( $products ) > 0) {
					foreach ( $products as $product ) {
						$orderitem = new OrdersItems ();
						
						if (!empty($product ['oldorderitemid']) && is_numeric ( $product ['oldorderitemid'] )) {
							
							// Find the details of the old order item details
							$oldOrderDetails = OrdersItems::find ( $product ['oldorderitemid'], null, true );
	
							// Check if the last order is present in the db and check if the product must be renewed
							if (!empty ( $oldOrderDetails [0] ) && $product['renew']) {
								
								// Set the new order details fields
								$orderitem->order_id = $orderid;
								$orderitem->product_id = $oldOrderDetails [0] ['product_id'];
								$orderitem->billing_cycle_id = $oldOrderDetails [0] ['billing_cycle_id'];
								
								if ($product ['type'] == "service") {
									
									// Get the number of the months to be sum to the expiration date of the service
									$date_end = Shineisp_Commons_Utilities::add_date ( date ( $oldOrderDetails [0] ['date_end'] ), null, BillingCycle::getMonthsNumber ( $oldOrderDetails [0] ['billing_cycle_id'] ) * $oldOrderDetails [0] ['quantity'] );
									
									$orderitem->date_start = $oldOrderDetails [0] ['date_end']; // The new order will have the date_end as date_start
									$orderitem->date_end = Shineisp_Commons_Utilities::formatDateIn ($date_end);
									$orderitem->price = $oldOrderDetails [0] ['price'];
									$orderitem->vat = $oldOrderDetails [0] ['vat'];
									$orderitem->percentage = $oldOrderDetails [0] ['percentage'];
									$orderitem->subtotal = $oldOrderDetails [0] ['subtotal'];
									$orderitem->cost = $oldOrderDetails [0] ['cost'];
									
								} elseif ($product ['type'] == "domain") {
									
									// Get the number of the months to be sum to the expiration date of the domain
									$parameters = json_decode($oldOrderDetails [0] ['parameters'], true);
									$tldid = !empty($parameters['tld']) ? $parameters['tld'] : NULL;
									$domain = !empty($parameters['domain']['name']) ? $parameters['domain']['name'] : NULL;
									
									// get the tld information
									$arrdomain = Shineisp_Commons_Utilities::getTld($domain);
									
									if(!empty($arrdomain[1])){
										$tld = DomainsTlds::getbyTld($arrdomain[1]);
										if(!empty($tld['tld_id'])){
											$tax = Taxes::getTaxbyTldID($tld['tld_id']);  // Check if the product has some tax to be added
											$orderitem->tld_id = $tld['tld_id'];
											
											if(!empty($tld['tax_id'])){
												$vat = ($tld ['renewal_price'] * $tax['percentage']) / 100;
												$subtotal = ($tld ['renewal_price'] * ($tax['percentage'] + 100) / 100);
												$percentage = $tax['percentage'];
											}else{
												$vat = 0;
												$subtotal = $tld ['renewal_price'];
												$percentage = 0;
											}
										}
									}
									
									$date_end = Shineisp_Commons_Utilities::add_date ( date ( $product ['expiring_date'] ), null, BillingCycle::getMonthsNumber ( $oldOrderDetails [0] ['billing_cycle_id'] ) * $oldOrderDetails [0] ['quantity'] );
									
									$orderitem->date_start = $product ['expiring_date']; // The new order will have the date_end as date_start
									$orderitem->date_end = Shineisp_Commons_Utilities::formatDateIn ($date_end);
									$orderitem->parameters = json_encode ( array ('domain' => array('name' => trim($domain), 'tldid' => $tldid, 'action' => 'renewDomain', 'authinfo' => null )));
									$orderitem->vat = $vat;
									$orderitem->percentage = $percentage;
									$orderitem->subtotal = $subtotal;
									$orderitem->price = $tld ['renewal_price'];
									$orderitem->cost = $tld ['renewal_cost'];
								}
								
								$orderitem->autorenew = $oldOrderDetails [0] ['autorenew'];
								$orderitem->description = $oldOrderDetails [0] ['description'];
								$orderitem->quantity = $oldOrderDetails [0] ['quantity'];
								$orderitem->status_id = Statuses::id("tobepaid", "orders"); // To be payed status set
								
								$orderitem->save ();
								$newOrderItemId = $orderitem->getIncremented ();
								
								// Attach all the services, products, and domains with the order
								$oldOID = OrdersItemsDomains::findIDsByOrderItemID ( $product ['oldorderitemid'], null, true );
								if (isset ( $oldOID [0] )) { // Some services are not linked to a domain
									$ordersitemsdomains = new OrdersItemsDomains ();
									$ordersitemsdomains->domain_id = $oldOID [0] ['domain_id'];
									$ordersitemsdomains->order_id = $orderid;
									$ordersitemsdomains->orderitem_id = $newOrderItemId;
									$ordersitemsdomains->save ();
								}
								$i ++;
							}
						}
					}
					
					// If there are items to be save ...
					if ($i > 0) {
						// Update Order
						self::updateTotalsOrder($orderid);
					}
					return $orderid;
				
				}
			}
		}
	}
	
	/**
	 * Create an order using only one product 
	 * @param $product
	 * @param $type [domain, service]
	 * @param $iddomgen [id of the domain or the id of the generic product]
	 * @param $customer_id
	 * @param $amount
	 * @param $note
	 * @return void
	 */
	public static function createOrderForSingleProduct(array $product, $type, $iddomgen, $customer_id, $amount, $note = "") {
		$order    = new Orders ();
		$customer = Customers::getAllInfo($customer_id);
		try {
			$tax = Taxes::getTaxbyProductID ( $product ['id'] );
			if (is_numeric ( $amount ) && $amount > 0) {
				// Creating a new Order.
				$order->customer_id = $customer_id;
				$order->isp_id      = $customer['isp_id'];
				$order->order_date  = date ( 'Y-m-d' );
				$order->note        = $note;
				$order->status_id   = Statuses::id("processing", "orders"); // Processing
				

				if (isset ( $tax ['percentage'] ) && $tax ['percentage'] > 0 && !Customers::isVATFree($order->customer_id)) {
					$order->total      = $amount / ((100 + $tax ['percentage']) / 100);
					$order->vat        = $amount - $order->total;
					$order->grandtotal = $amount;
				} else {
					$order->total      = $amount;
					$order->vat        = 0;
					$order->grandtotal = $amount;
				}
				
				$order->save ();
				$id = $order->getIncremented ();
				
				// Attaching the order item to the order previously created. 
				$orderitem = new OrdersItems ();
				$date_end = Shineisp_Commons_Utilities::add_date ( date ( 'd-m-Y' ), null, 12 ); // Fixed Renew
				

				$orderitem->order_id         = $id;
				$orderitem->product_id       = $product ['id'];
				$orderitem->billing_cycle_id = 1;
				$orderitem->date_start       = date ( 'Y-m-d' );
				$orderitem->date_end         = $date_end;
				$orderitem->autorenew        = true;
				$orderitem->description      = $product ['name'];
				$orderitem->cost             = $product ['cost'];
				$orderitem->quantity         = 1;
				if (isset ( $tax ['percentage'] ) && $tax ['percentage'] > 0 && !Customers::isVATFree($order->customer_id)) {
					$orderitem->price = $amount / ((100 + $tax ['percentage']) / 100);
				} else {
					$orderitem->price = $amount;
				}
				$orderitem->status_id = Statuses::id("processing", "orders"); // Processing status set
				$orderitem->save ();
				$detailid = $orderitem->getIncremented ();
				
				// If the product type is not a domain we have to add a record in the Orders_items_domains table
				// in order to join the domain with the order detail
				if ($type != "domain") {
					$ordersitemsdomains = new OrdersItemsDomains ();
					$ordersitemsdomains->domain_id = $iddomgen;
					$ordersitemsdomains->order_id = $id;
					$ordersitemsdomains->orderitem_id = $detailid;
					$ordersitemsdomains->save ();
					
					Domains::setStatus ( $iddomgen, Statuses::id("processing", "domains") ); // Set the domains status as processing
					Domains::setExpirationDate ( $iddomgen, $date_end ); // Set the new expiration date
				}
				return $id;
			}
		} catch ( Exception $e ) {
			echo $e->getMessage ();
			die ();
		}
	}

	/**
	 * Create and Retrieve the OrderID
	 * @param integer $id
	 * @return Orders 
	 */
	public static function create($customerId, $statusId = "", $note = ""){
		$customer = Customers::getAllInfo($customerId);
		$isp_id   = $customer['isp_id'];
		
		if(self::$order){
			return self::$order;
		}
				
		if(is_numeric($customerId)){
			$order = new Orders ();
			
			// Execute a custom event
			self::events()->trigger('orders_create_before', "Orders", array('order' => $order, 'customerid' => $customerId));
			
			$order['customer_id']   = $customerId;
			$order['order_date']    = date ( 'Y-m-d H:i:s' );
			$order['expiring_date'] = date ( 'Y-m-d' , strtotime ( '30 days' , strtotime ( $order['order_date'] ) ));
			$order['isp_id']        = $isp_id;
			$order['status_id']     = is_numeric($statusId) ? $statusId : Statuses::id("tobepaid", "orders");
			$order['uuid']          = Shineisp_Commons_Uuid::generate();
			
			// Save the data
			$order->save();
			
			// Save order number
			$order->order_number = self::formatOrderId($order->order_id);
			
			// Save the order
			if($order->trySave()){
			
				// Log status change
				self::logStatusChange($order->order_id, $order->status_id);
							
				// Assign the order var to the static var
				self::$order = $order;
				
				// Create the fastlink for the order
				$fastlink = Fastlinks::CreateFastlink('orders', 'edit', json_encode ( array ('id' => $order['order_id'] ) ), 'orders', $order['order_id'], $customerId);
				
				// Add a message within the order
				Messages::addMessage($note, $customerId, null, $order['order_id']);
				
				// Execute a custom event
				self::events()->trigger('orders_create_after', "Orders", array('order' => $order, 'fastlink' => $fastlink));
				
				// Return the order object var
				return self::$order;
			}else{
				throw new Exception('There was a problem when I try to create the order', 1003);
			}
			
		}else{
			throw new Exception('Customer ID has been not found', 1001);
		}
		
		return null;
	}
	
	/**
	 * Add an item within an order 
	 * 
	 * @param Cart $item
	 * @throws Exception
	 * @return unknown
	 */
	public static function addOrderItem(CartItem $item){
		
		if(empty(self::$order)){
			throw new Exception('The order has not been created yet', 1000);
		}
		
		try{
		
			// get the item subtotals
			$subtotals = $item->getSubtotals();
			
			// get the options
			$options = $item->getOptions();
			
			// Get the order object previously created
			$order = self::$order;
			
			// add a new item
			$orderitem = new OrdersItems();
			
			$orderitem->order_id = $order['order_id'];
			
			if("domain" == $item->getType()){  // Create a new domain order item
				$orderitem->tld_id = !empty($options['domain']['tld']) ? $options['domain']['tld'] : null;
				$orderitem->parameters = json_encode ($options);
			}else{
				$orderitem->product_id = $item->getId();
				$orderitem->parameters = json_encode (ProductsAttributes::getSystemAttributes($item->getId()));
			}
			
			$orderitem->status_id = Statuses::id("tobepaid", "orders");
			$orderitem->date_start = date ( 'Y-m-d H:i:s' );
			$orderitem->date_end = null;
			$orderitem->description = $item->getName();
			$orderitem->quantity = $item->getQty();
			$orderitem->price = $item->getUnitprice();
			$orderitem->billing_cycle_id = $item->getBillingid();
			$orderitem->vat = $subtotals['taxes'];
			$orderitem->percentage = $subtotals['percentage'];
			$orderitem->uuid = $item->getUid();
			
			// Count of the day until the expiring
			if($item->getIsrecurring()){
				
				// get the months until of the next service expiration
				$months = $subtotals['months'];
				
				if($months > 0){
					$totmonths = intval ( $item->getQty() * $months );
					
					// Calculate the total of the months 
					$date_end = Shineisp_Commons_Utilities::add_date ( date ( 'd-m-Y H:i:s' ), null, $totmonths );
					
					$orderitem->date_end = Shineisp_Commons_Utilities::formatDateIn($date_end);
				}else{
					$orderitem->date_end = null;
				}
			}
			
			$orderitem->cost = $item->getCost();
			$orderitem->setupfee = $subtotals['setupfee'];
			$orderitem->subtotal = $subtotals['subtotal'];
			
			// Save the order item
			if($orderitem->trySave()){

				// Attach all the the domain to the order
				if ("domain" == $item->getType()) { 
					$domain = $options['domain']['name'];
					$tld = $options['domain']['tld'];
					
					$domainId = Domains::Create($domain, $tld, $order->customer_id, $orderitem->detail_id);
					if(is_numeric($domainId)){
						$ordersitemsdomains = new OrdersItemsDomains ();
						$ordersitemsdomains->domain_id = $domainId;
						$ordersitemsdomains->order_id = $order['order_id'];
						$ordersitemsdomains->orderitem_id = $orderitem->detail_id;
						$ordersitemsdomains->save ();
					}
				}
				
				// Update the totals of the order
				self::updateTotalsOrder($order['order_id']);
				
				return $orderitem;
			}
			
		}catch(Exception $e){
			Shineisp_Commons_Utilities::log('There was a problem during the order creation: ' . $e->getMessage());
		}
		
		return false;
	}
	
	/**
	 * Apply late fee in the order
	 * 
	 * 
	 * @param integer $orderID
	 */
	public static function applyLateFee($orderid) {
		$oderid = (int)$orderid;
		if ( $oderid > 0 ) {
			$translations = Shineisp_Registry::getInstance ()->Zend_Translate;
			
			$order = self::find ( $orderid );
			if ( !isset($order->order_id) || !is_numeric($order->order_id) ) {
				return null;
			}
						
			//* Get late fee details
			$late_fee_days   = (int)Settings::findbyParam('late_fee_days');
			$late_fee_amount = (int)Settings::findbyParam('late_fee_amount');
			$late_fee_type   = strtolower(Settings::findbyParam('late_fee_type'));
			
			//* No late fee
			if ( $late_fee_amount < 1 ) {
				return $order->toArray();		
			}
			
			$datetime1 = new DateTime($order->expiring_date);
			$datetime2 = new DateTime(date('Y-m-d'));
			$interval  = $datetime1->diff($datetime2);
			$days      = (int)$interval->format('%R%a');
			
			//* To early, skip late fee
			if ( $days < $late_fee_days ) {
				return $order->toArray();	
			}
			
			//* Check if late fee already exists in this order. In that case, do not apply a new fee
			foreach ( OrdersItems::getAllDetails($order->order_id) as $_item ) {
				if ( isset($_item->description) && stripos($_item->description, 'Late fee') !== false ) {
					return $order->toArray();
				}
			}

			//* Calculate the late fee amount based on settings
			$lateFeeAmount = ( $late_fee_type == 'fixed' ) ? $late_fee_amount : $order->total + ($order->total*$late_fee_amount/100);
			
			$item = new OrdersItems();
			
			$item['order_id']         = $orderid;
			$item['status_id']        = Statuses::id("tobepaid", "orders");
			$item['description']      = 'Late fee';
			$item['billing_cycle_id'] = 5; //* TODO: Detect 'No expiring' billing
			$item['quantity']         = 1;
			$item['setupfee']         = $lateFeeAmount;
		
			$item->save();
			
			self::updateTotalsOrder($orderid);
			
			$order = self::find ( $orderid );
			
			return $order->toArray();			
		}
		
		return null;
		
	}
	
	/**
	 * Create an order with many products
	 * 
	 *  
	 * @param $product
	 * @return integer $orderID
	 */
	public static function createOrderWithMultiProducts(array $products, $customer_id, $type = "domain") {
		$order = new Orders ();
		try {
			$customer = Customers::getAllInfo($customer_id);
			$isp_id   = $customer['isp_id'];
			
			// Creating a new Order.
			$order->customer_id = $customer_id;
			$order->isp_id      = $isp_id;
			$order->order_date  = date ( 'Y-m-d' );
			$order->status_id   = Statuses::id("tobepaid", "orders"); // To pay
			$order->save ();
			
			$id = $order->getIncremented ();
			
			// Add a fastlink to a order
			$link_exist = Fastlinks::findlinks ( $id, $customer_id, 'orders' );
			if (count ( $link_exist ) == 0) {
				$link = new Fastlinks ();
				$link->controller  = "orders";
				$link->action      = "edit";
				$link->params      = json_encode ( array ('id' => $id ) );
				$link->customer_id = $customer_id;
				$link->sqltable    = "orders";
				$link->id          = $id;
				$link->code        = Shineisp_Commons_Utilities::GenerateRandomString ();
				$link->save ();
			}
			
			foreach ( $products as $product ) {
				
				$product = Domains::getAllInfo ( $product, null, null, true );
				
				// Attaching the order item to the order previously created. 
				$orderitem = new OrdersItems ();
				$date_end = Shineisp_Commons_Utilities::add_date ( date ( 'd-m-Y' ), null,  365 ); // Fixed Renew

				$orderitem->order_id         = $id;
				$orderitem->product_id       = $product [0] ['Products'] ['product_id'];
				$orderitem->billing_cycle_id = 1;
				$orderitem->date_start       = date ( 'Y-m-d H:i:s' );
				$orderitem->date_end         = $date_end;
				$orderitem->autorenew        = true;
				$orderitem->description      = $product [0] ['domain'] . "." . $product [0] ['tld'];
				$orderitem->quantity         = 1;
				
				$tax = Taxes::getTaxbyProductID ( $product [0] ['Products'] ['product_id'] );
				
				$orderitem->price = $product [0] ['Products'] ['price_1'];
				$orderitem->cost  = $product [0] ['Products'] ['cost'];
				
				$orderitem->status_id = Statuses::id("processing", "orders"); // Processing status set
				$orderitem->save ();
				$detailid = $orderitem->getIncremented ();
				
				// Set the domains status as processing
				Domains::setStatus ( $product [0] ['domain_id'], 6 );
			}
			
			// Update the total of the order
			self::updateTotalsOrder ( $id );
			return $id;
		
		} catch ( Exception $e ) {
			echo $e->getMessage ();
			die ();
		}
	}
	
	/**
	 * Check if the order has been invoiced
	 * 
	 * @param boolean
	 */
	public static function isInvoiced($orderid) {
		$record = Doctrine_Query::create ()->select ( 'o.order_id, o.invoice_id' )
						->from ( 'Orders o' )
						->where ( "order_id = ?", $orderid )
						->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
		
		return !empty($record[0]['invoice_id']) ? $record[0]['invoice_id'] : false;
	}
	
	/**
	 * Check if the order become from an upgrade
	 * 
	 * @param integer $orderid
	 */
	public static function isUpgrade( $orderid ) {
		$orderDetails	= Orders::getDetails($orderid);
		foreach( $orderDetails as $orderDetail ) {
			$parent_orderid	= intval($orderDetail['parent_orderid']);
			if( $parent_orderid != 0 ) {
				return $parent_orderid;
			}
		}
		
		return false;		
	}
	
	
	/*
	 * Run task functions
	 * THIS METHOD MUST BE CALLED ONLY WHEN AN ORDER IS COMPLETE
	 */
	private static function RunTasks($orderid) {
		if (empty($orderid) || !is_numeric($orderid) ) {
			return false;
		}

		// Create the domain requested by the order from the client as domain records
		// and create a task to register or transfer the domain
		self::CreateDomainTasks($orderid);
		
		//* Hosting creation actions
		self::CreateHostingTasks($orderid);
	}	

	/**
	 * Create the tasks for hosting plans
	 * @param integer $orderid
	 */
	private static function CreateHostingTasks($orderid) {
		if (empty($orderid) || !is_numeric($orderid) ) {
			return false;
		}
		
		$hostingplans = self::get_hostingplans_from_order($orderid);
		if($hostingplans){
			foreach ( $hostingplans as $data ) {
				PanelsActions::AddTask($data['customer_id'], $data['orderitem_id'], "fullProfile", $data['parameters']);
			}
		}
	}
	
	/*
	 * Complete 
	 * this function complete the order
	 * set the payment, create the domain tasks, and set the status of the new domains
	 */
	public static function Complete($orderid, $sendemail=false) {
		
		if(!empty($orderid) && is_numeric($orderid) ){
			
			// Execute a custom event
			self::events()->trigger('orders_complete_before', "Orders", array('orderid' => $orderid));
			
			// Activate services if autosetup is set to 3.
			self::activateItems($orderid, 3);

			// Set the status of the orders and the status of the items within the order just created
			self::set_status ( $orderid, Statuses::id("complete", "orders") ); // Complete

			// Execute a custom event
			self::events()->trigger('orders_complete_after', "Orders", array('orderid' => $orderid));
			
			// log
			Shineisp_Commons_Utilities::logs ( "Order completed: $orderid", "orders.log" );
			
			return $orderid;
		}
		
		return false;		
	}

	/**
	 * activateItems: activate one or more order items based on autosetup flag
	 * 
	 * @param  orderId: order id to activate
	 *         autosetup: autosetup value to manage
	 * @return true|false 
	 */
	public static function activateItems($orderId, $autosetup = 0) {
		Shineisp_Commons_Utilities::logs ( __METHOD__ . "(".$orderId.", ".$autosetup.")" );
	    $autosetup = intval($autosetup);
		if ( $autosetup === 0 ) {
			return true;
		}
	   
		$activableItems = OrdersItems::getAllActivableItems($orderId);
		if ( empty($activableItems) ) {
			Shineisp_Commons_Utilities::logs ( __METHOD__ . "(".$orderId.", ".$autosetup."): no activable product" );
			return true;
		}
        
		foreach ( $activableItems as $item ) {
			if ( empty($item->parameters) && empty( $item->callback_url) ) {
				Shineisp_Commons_Utilities::logs ( __METHOD__ . "(".$orderId.", ".$autosetup."): product ".serialize($item)." with no parameter set" );
				// parameters are needed for both domains and hosting.
				continue;
			}
            
            // echo $item->Products->autosetup;
            // var_dump( isset($item->Products) && isset($item->Products->autosetup) && intval($item->Products->autosetup) === $autosetup );
            if ( isset($item->Products) && isset($item->Products->autosetup) && intval($item->Products->autosetup) === intval($autosetup) ) {
            	Shineisp_Commons_Utilities::logs ( __METHOD__ . "(".$orderId.", ".$autosetup."): Hosting Detail Id #".$item->detail_id." start activation");
                OrdersItems::activate($item->detail_id);               
            }
            
            if ( isset($item->tld_id) && intval($item->tld_id) > 0 && DomainsTlds::getAutosetup($item->tld_id) === $autosetup ) {
            	Shineisp_Commons_Utilities::logs ( "Orders::activateItems(".$orderId.", ".$autosetup."): Domain Detail Id ".$item->detail_id." start activation" );
                OrdersItems::activate($item->detail_id);    
            }
		}		

		Shineisp_Commons_Utilities::logs (__METHOD__ . "(".$orderId.", ".$autosetup."). End activations");
	}

	
	/*
	 * CreateDomainTasks
	 * create the tasks for each domain within a order
	 * Add the domains found in the task table action in order to execute the register/transfer procedure
	 */
	private static function CreateDomainTasks($OrderID) {
		// Check if the order contains domains
		if (is_numeric ( $OrderID )) {
			$domains = self::getDomainsFromOrder ( $OrderID );
			if (count ( $domains ) > 0) {
				
				// Create the new domains 
				for($i = 0; $i < count ( $domains ); $i ++) {
					$domains [$i] ['domain_id'] = Domains::Create ( $domains [$i] ['domain'], $domains[$i]['tld_id'], $domains [$i] ['customer_id'], $domains [$i] ['orderitem_id'] );
				}
				
				// Add the tasks in order to register or transfer them
				$retval = DomainsTasks::AddTasks ( $domains );
				if ($retval === true) {
					return true;
				} else {
					return $retval;
				}
			}
		}
	}
	
	/**
	 * getAll
	 * Get records the orders from the DB
	 * @return array
	 */
	public static function getAll($fields = "*") {
		
		// Defining the url sort
		return self::getDQL()->select ( $fields )->orderBy ( 'order_date desc' )->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
	}
	
	/**
	 * find
	 * Get a record by ID
	 * @param $id
	 * @return Doctrine Record
	 */
	public static function find($id) {
		return Doctrine::getTable ( 'Orders' )->find ( $id );
	}
	
	/**
	 * find
	 * Get a record by externalID
	 * @param $id
	 * @return Doctrine Record
	 */
	public static function findbyExternalID($id) {
		return Doctrine::getTable ( 'Orders' )->findOneBy ( 'external_id', $id );
	}
	
	/**
	 * find_all_not_paid_ordersbyCustomerID
	 * Get all the not payed orders records
	 * @param $id
	 * @return array Record
	 */
	public static function find_all_not_paid_ordersbyCustomerID($customerid) {
		$dq = Doctrine_Query::create ()->from ( 'Orders o' )
		->leftJoin ( 'o.Invoices i' )
		->leftJoin ( 'o.Statuses s' )
		->where ( "o.customer_id = ?", $customerid )
		->andWhere ( "s.status_id = ?", Statuses::id("tobepaid", "orders") );
		return $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
	}
	
	/**
	 * Get all the not paid orders 
	 * Renewal orders will be not selected
	 * 
	 * @return ArrayObject 
	 */
	public static function find_all_not_paid_orders() {
		$dq = Doctrine_Query::create ()->from ( 'Orders o' )
										->leftJoin ( 'o.Statuses s' )
										->where ( "s.status_id = ?", Statuses::id("tobepaid", "orders") )
										->andWhere("o.is_renewal = ?", false);
										
		return $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
	}
	
	/**
	 * Get all the expired orders without renewal
	 * 
	 * @param Date $date 
	 * @return ArrayObject 
	 */
	public static function find_all_expired_orders($date) {
		$dq = Doctrine_Query::create ()->from ( 'Orders o' )
										->leftJoin ( 'o.Statuses s' )
										->where ( "s.status_id = ?", Statuses::id("tobepaid", "orders") )
										->andWhere("o.expiring_date <= ?", $date)
										->andWhere('o.is_renewal = ?', FALSE);
							
		return $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
	}
	
	/**
	 * Delete an order using its ID and the customer id.
	 * @param $id, $customerid
	 * @return boolean
	 */
	public static function DeleteByID($id, $customerid=null) {
		
		// Execute a custom event
		self::events()->trigger('orders_deleted_before', "Orders", array('orderid' => $id, 'customerid' => $customerid));
		
		$dq = Doctrine_Query::create ()->delete ()->from ( 'Orders o' )->where ( 'order_id = ?', $id );
					
		if(is_numeric($customerid)){
			$dq->andWhere ( "customer_id = ?", $customerid );
		}
			
		$result = $dq->execute ();
		
		// Execute a custom event
		self::events()->trigger('orders_deleted_after', "Orders", array('orderid' => $id, 'customerid' => $customerid));
		
		return $result;
	}
	
	/**
	 * Check if the order can be deleted
	 * @param $id, $customerid
	 * @return boolean
	 */
	public static function IsEraseable($id, $customerid=null) {
		$dq = Doctrine_Query::create ()->from ( 'Orders o' )
					->where ( 'order_id = ?', $id )
					->limit(1);
					
		if(is_numeric($customerid)){
			$dq->andWhere ( "customer_id = ?", $customerid );
		}
					
		$record = $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY);
		
		// If the order is not a renewal or there is not any invoice to be paid then it can be deleted
		if(!empty($record[0])){
			if($record[0]['is_renewal']){  // It is a renewal order
				return false;
			}elseif(!empty($record[0]['invoice_id'])){ // It is a invoiced order
				return false;
			}else{ // other cases
				return true;
			}
		}
		return false;
	}
	
	/**
	 * Check if the user can write comments in the order 
	 * 
	 * @param $id
	 * @return boolean
	 */
	public static function IsCommentable($id) {
		$dq = Doctrine_Query::create ()->from ( 'Orders o' )
					->where ( 'order_id = ?', $id )
					->limit(1);
					
		$record = $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY);
		
		if(!empty($record[0])){
			if($record[0]['status_id'] == Statuses::id('tobepaid', 'orders')){ 
				return true;
			}elseif($record[0]['status_id'] == Statuses::id('paid', 'orders')){ 
				return true;
			}elseif($record[0]['status_id'] == Statuses::id('pending', 'orders')){ 
				return true;
			}elseif($record[0]['status_id'] == Statuses::id('processing', 'orders')){ 
				return true;
			}
		}
		return false;
	}
	
	/**
	 * setDeleted
	 * Set the order as deleted
	 * @param $id, $customerid
	 * @return boolean
	 */
	public static function setDeleted($id, $customerid) {
		$dq = Doctrine_Query::create ()->update('Orders o' )
					->set('status_id', Statuses::id("deleted", "orders"))
					->where ( 'order_id = ?', $id )
					->andWhere ( "customer_id = ?", $customerid );
		$dq->execute ();
		
		$dq = Doctrine_Query::create ()->update('OrdersItems oi' )
					->set('status_id', Statuses::id("deleted", "orders"))
					->where ( 'order_id = ?', $id );
		$dq->execute ();
		
		$customer = Customers::getAllInfo($customerid);
		
		$order = self::getAllInfo ( $id, null, true );
		$date  = explode ( "-", $order [0] ['order_date'] );
				
		Shineisp_Commons_Utilities::sendEmailTemplate($customer ['email'], 'order_deleted', array(
			 'orderid'    => $order[0]['order_number']
			,'fullname' => $customer['lastname']
			,':shineisp:' => Isp::getActiveISP()
			,'conditions' => strip_tags(Settings::findbyParam('conditions'))
		), null, null, null, null, $customer['language_id']);

		return true;
	}
	
	/**
	 * DeleteByCustomerID
	 * Delete all the orders of a selected customer
	 * @param $customerid
	 * @return boolean
	 */
	public static function DeleteByCustomerID($customerid) {
		$dq = Doctrine_Query::create ()->delete ()->from ( 'Orders o' )->where ( "customer_id = ?", $customerid );
		return $dq->execute ();
	}
	
	/**
	 * findByCustomerID
	 * Get a record by CustomerID
	 * @param $id
	 * @return Doctrine Record
	 */
	public static function findByCustomerID($id) {
		return Doctrine::getTable ( 'Orders' )->findBy ( 'customer_id', $id );
	}
	
	/**
	 * getList
	 * Get a list ready for the html select object
	 * @return array
	 */
	public static function getList($empty = false) {
		$items = array ();
		$registry = Shineisp_Registry::getInstance ();
		$translations = $registry->Zend_Translate;
		
		$dq = Doctrine_Query::create ()->select ( "order_id, DATE_FORMAT(order_date, '".Settings::getMySQLDateFormat('dateformat')."') as orderdate, s.status as status, CONCAT(c.firstname, ' ', c.lastname, ' ', c.company) as fullname" )->from ( 'Orders o' )->leftJoin ( 'o.Customers c' )->leftJoin ( 'o.Statuses s' );
		$retval = $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
		
		if ($empty) {
			$items [] = $translations->translate ( 'Select ...' );
		}
		foreach ( $retval as $c ) {
			$items [$c ['order_id']] = $c ['orderdate'] . " - " . $c ['order_id'] . " - " . $c ['fullname'] . " - [" . $c['status']. "] ";
		}
		
		return $items;
	}
	
	/**
	 * updateTotalsOrder
	 * Get a list ready for the html select object
	 * @return array
	 */
	public static function updateTotalsOrder($id) {
		$total = 0;
		$vat   = 0;
		$discount   = 0;
		$costs = 0;
		try {
			$order = self::find ( $id );
			
			// If the status is COMPLETE the totals will be not changed
			if($order->status_id == Statuses::id("complete", "orders") || $order->status_id == Statuses::id("paid", "orders") || $order->status_id == Statuses::id("processing", "orders") ){
				return $order->total + $order->vat;
			}
			
			if ($order && is_numeric ( $id )) {
				 
				// Get all the order details
				$details = OrdersItems::getAllDetails($id, null, true);
				
				if(!empty($details[0])){
					$isTaxFree = Customers::isTaxFree($details [0] ['Orders'] ['Customers'] ['customer_id']);
					$isVATFree = Customers::isVATFree($details [0] ['Orders'] ['Customers'] ['customer_id']);
	
					foreach ( $details as $detail ) {
						
						$type = !empty($detail['product_id']) && is_numeric($detail['product_id']) ? "product" : "domain";
						$product = $detail['Products'];
						
						if($type == "domain"){
							
							// Calculate the price per Quantity
							$subtotal = $detail ['price']  * $detail ['quantity'];
							
							$setupfee = 0;
							
						}elseif($type == "product"){

							$isRecurring = Products::isRecurring($detail['product_id']);
							
							if($isRecurring){
							
								$setupfee = $detail ['setupfee'];
								$subtotal = $detail ['price'];
								
								// Price multiplier
								$months = $detail ['BillingCycle'] ['months'];
								if(!empty($months) && is_numeric($months)){
								    $subtotal = ($detail ['price'] * $months);
								}
								
								// Calculate the price per the months per Quantity
								$subtotal = $subtotal * $detail ['quantity'];
								
								if(!empty($detail ['discount'])){
									$discount = ($subtotal * $detail ['discount']) / 100;
								}
								
							}else{
								
								$setupfee = $detail ['setupfee'];
								
								// Calculate the price per Quantity
								$subtotal = $detail ['price'] * $detail ['quantity'];
								
								if(!empty($detail ['discount'])){
									$discount = ($subtotal * $detail ['discount']) / 100;
								}
							}
							
						}
						
						// ... and add the setup fees
						$price = $subtotal + $setupfee - $discount;
						$total += $price;
						$costs += $detail ['cost'] * $detail ['quantity'];
						
						if( !$isTaxFree && !$isVATFree ){
							
							// If the product is a domain 
							if($type == "domain"){
								$tax = Taxes::getTaxbyTldID($detail ['tld_id']);	
							}else{ // If not
								$tax = Taxes::getTaxbyProductID($detail ['product_id']);
							}
						
							if(!empty($tax['percentage'])){
								$vat += is_numeric ( $price ) ? ($price * $tax['percentage']) / 100 : 0;
							}
						}
					}
					
					$order->vat = $vat;
					$order->total = $total;
					$order->cost = $costs;
					$order->grandtotal = $total + $vat;
					
					// Update the order data
					$order->save ();
					return $total + $vat;
				}
				
				return 0;
			}
		} catch ( Exception $e ) {
			die ( $e->getMessage () );
		}
	}
	
	/**
	 * getStatus
	 * Get the status of the order  
	 * @param $id
	 * @return Doctrine Record / Array
	 */
	public static function getStatus($id, $retarray = false) {
		$registry = Shineisp_Registry::getInstance ();
		$translations = $registry->Zend_Translate;
		$dq = Doctrine_Query::create ()->select ( 'o.order_id, s.status' )->from ( 'Orders o' )->leftJoin ( 'o.Statuses s' )->where ( "order_id = $id" );
		
		$retarray = $retarray ? Doctrine_Core::HYDRATE_ARRAY : null;
		$record = $dq->execute ( array (), $retarray );
		return ! empty ( $record [0] ['Statuses'] ['status'] ) ? $translations->translate ( $record [0] ['Statuses'] ['status'] ) : "N/A";
	}
	
	/**
	 * getAllInfo
	 * Get all data starting from the orderID 
	 * @param $id
	 * @return Doctrine Record / Array
	 */
	public static function getAllInfo($id, $fields = "*", $retarray = false, $owner = false) {
		try {
			$dq = self::getDQL()->where ( "order_id = $id" )->limit ( 1 );
			
			if($fields != "*"){
				$dq->select ( $fields );
			}
			
			if (is_numeric($owner)) {
				$dq->addWhere ( '(o.customer_id = ? OR c.parent_id = ?)', array($owner, $owner) );
			}
			
			$retarray = $retarray ? Doctrine_Core::HYDRATE_ARRAY : null;
			$items = $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
			
			// Manage fullname
			if ( is_array($items) && isset($items[0]) ) {
				// Convert order number if empty
				if ( !isset($items[0]['order_number']) && isset($items[0]['order_id']) ) {
						$items[0]['order_number'] = self::formatOrderId($items[0]['order_id']);
				}
				
				if ( !empty($items[0]['Customers']) ) {
					if ( !empty($items [0] ['Customers']['company']) ) {
						$items [0] ['Customers']['fullname']        = $items [0] ['Customers']['company'];
						$items [0] ['Customers']['full_personname'] = $items [0] ['Customers']['lastname'].' '.$items [0] ['Customers']['firstname'];
					} else {
						$items [0] ['Customers']['fullname'] = $items [0] ['Customers']['lastname'].' '.$items [0] ['Customers']['firstname'];	
					}
				}
			}
			
			return $items;
		} catch ( Exception $e ) {
			die ( $e->getMessage () );
		}
	}
	
	/**
	 * Get the customer from the order 
	 * @param $orderid
	 * @return Doctrine Record / Array
	 */
	public static function getCustomer($orderid) {
		try {
			$dq = Doctrine_Query::create ()->select ( 'order_id, customer_id' )->from ( 'Orders o' )->leftJoin ( 'o.Customers c' )->where ( "order_id = ?", $orderid )->limit ( 1 );
			
			$record = $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
			
			if (! empty ( $record [0] ['customer_id'] ) && is_numeric ( $record [0] ['customer_id'] )) {
				return $record [0] ['customer_id'];
			} else {
				return false;
			}
		} catch ( Exception $e ) {
			die ( $e->getMessage () );
		}
	}
	
	/**
	 * Get all the details from a order
	 * 
	 * @param integer $id 
	 * @param string $fields
	 */
	public static function getDetails($id, $fields=NULL) {
		$dq = Doctrine_Query::create ()->select ( "oid.relationship_id, 
								                     dm.domain_id, 
								                     dt.tld_id,
								                     ws.tld,
								                     CONCAT(dm.domain, '.',ws.tld) as domain, 
								                     o.order_number,
								                     d.quantity, 
								                     d.description, 
								                     d.price as price, 
								                     d.setupfee as setupfee, 
		                                             d.vat,
								                     d.subtotal,
								                     d.parent_detail_id as parent_orderid,
								                     t.percentage as taxpercentage,
								                     DATE_FORMAT(d.date_start, '".Settings::getMySQLDateFormat('dateformat')."') as start, 
								                     DATE_FORMAT(d.date_end, '".Settings::getMySQLDateFormat('dateformat')."') as end" )
										->from ( 'OrdersItems d' )
										->leftJoin ( 'd.Orders o' )
										->leftJoin ( 'd.OrdersItemsDomains oid ON d.detail_id = oid.orderitem_id' )
										->leftJoin ( 'oid.Domains dm' )
										->leftJoin ( 'd.Products p' )
										->leftJoin ( 'dm.DomainsTlds dt' )
										->leftJoin ( 'dt.WhoisServers ws' )
										->leftJoin ( 'p.Taxes t' )
										->leftJoin ( 'o.Customers c' )
										->leftJoin ( 'd.Statuses s' )
										->where ( 'o.order_id = ?', $id );
		
		if(!empty($fields)){
		    $dq->select($fields);
		}
		
		$rs = $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
		
		return $rs;
	}
		
	/**
	 * Check if the customer is the owner of the selected order 
	 * 
	 * 
	 * @param $orderid
	 * @param $customer_id
	 * @return Array
	 */
	public static function isOwner($orderid, $customer_id) {
		try {
			$dq = Doctrine_Query::create ()->select ( 'Count(*) as total' )
			->from ( 'Orders o' )
			->leftJoin( 'o.Customers c' )
			->where ( "order_id = ?", $orderid )
			->andWhere ( "o.customer_id = ?", $customer_id )
			->orWhere ( "c.customer_id = ?", $customer_id )
			->limit ( 1 );
			
			$record = $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
			if (! empty ( $record [0] ['total'] ) && $record [0] ['total'] > 0) {
				return true;
			} else {
				return false;
			}
			
		} catch ( Exception $e ) {
			die ( $e->getMessage () );
		}
	}
	
	/**
	 * Check if the order is totally paid
	 * 
	 * 
	 * @param $orderid
	 * @return true|false
	 */
	public static function isPaid($orderId = 0) {
		$orderId = intval($orderId);
		if ( $orderId < 1 ) {
			return false;
		}
		
		$Order = self::find($orderId);
		if ( !$Order || !isset($Order->grandtotal) || $Order->grandtotal <= 0 ) {
			return true;
		}
		
		$Payments    = Payments::findByOrderId($orderId);
		$totalIncome = 0;
		
		foreach ( $Payments as $Payment ) {
			$totalIncome += isset($Payment->income) ? $Payment->income : 0;
		}
		
		return ($totalIncome >= $Order->grandtotal);
	}
	
	
	/*
	 * Get all the domains requested from the order list items.
	 * 
	 * @param $orderID
	 */
	public static function getDomainsFromOrder($orderID) {
		$domains = array ();
		$i = 0;
		$items = OrdersItems::getAllDetails ( $orderID, null, true );
		if (count ( $items ) > 0) {
			foreach ( $items as $item ) {
				$params = json_decode ( $item ['parameters'], true );
				if (! empty ( $params ['domain'] )) {
					$domains [$i] ['orderitem_id'] = $item ['detail_id'];
					$domains [$i] ['customer_id'] = $item ['Orders'] ['Customers'] ['customer_id'];
					$domains [$i] ['action'] = ! empty ( $params ['action'] ) ? $params ['action'] : "registerDomain";
					$domains [$i] ['domain'] = trim ( strtolower ( $params ['domain'] ) );
					$domains [$i] ['authinfocode'] = !empty($params ['authinfocode']) ? trim ( $params ['authinfocode']) : "";
					$domains [$i] ['tld_id'] = Domains::getDomainIDbyName($domains [$i] ['domain']);
					$domains [$i] ['registrar_id'] = Domains::getRegistrarsIDbyName($params ['domain']);
					$i ++;
				}
			}
		}
		return $domains;
	}
	
	/**
	 * Get all the hosting plans requested from the order list items.
	 * @param $orderID
	 * @return ArrayObject
	 */
	public static function get_hostingplans_from_order($orderID) {
		$hplan = array ();
		$i = 0;
		$items = OrdersItems::getAllDetails ( $orderID, null, true );

		if (count ( $items ) > 0) {
			foreach ( $items as $item ) {
				if (strtolower($item ['Products']['type']) == "hosting") {
					if (! empty ( $item ['parameters'] )) {
						$hplan [$i] ['orderitem_id'] = $item ['detail_id'];
						$hplan [$i] ['customer_id'] = $item ['Orders'] ['Customers'] ['customer_id'];
						$hplan [$i] ['parameters'] = $item ['parameters'];
						$i ++;
					}else{
						Shineisp_Commons_Utilities::log("Hosting plan ".$item['Products']['sku']." has been skipped because it has not any parameters configured yet");
					}
				}
			}
		}
		return $hplan;
	}
	
	public static function getSetupfee($orderID) {
		$setupfee = 0;
		
		$items = OrdersItems::getAllDetails ( $orderID, null, true );
		if (count ( $items ) > 0) {
			foreach ( $items as $item ) {
				$tax = Taxes::getTaxbyProductID ( $item ['Products'] ['product_id'] );
				if ($tax ['percentage'] > 0) {
					$setupfee += number_format ( ($item ['setupfee'] * (100 + $tax ['percentage']) / 100), 2 );
				} else {
					$setupfee += number_format ( $item ['setupfee'], 2 );
				}
			
			}
		}
		
		return $setupfee;
	}
	
	/*
     * sendOrder
     * send the order by email
     * @param $orderID
     */
	public static function sendOrder($orderid, $customURL = null) {
		$bank = "";
		if (is_numeric ( $orderid )) {
			
			$order = self::getAllInfo ( $orderid, null, true );
			
			//if customer comes from reseller
			if ($order [0] ['Customers'] ['parent_id']) {
				$customer_email = Contacts::getEmails($order [0] ['Customers'] ['parent_id']);

				$invoice_dest = Customers::getAllInfo ( $order [0] ['Customers'] ['parent_id'] );
				$customer = $invoice_dest ['firstname'] . " " . $invoice_dest ['lastname'];
				$customer .= ! empty ( $invoice_dest ['company'] ) ? " - " . $invoice_dest ['company'] : "";
				$fastlink = Fastlinks::findlinks ( $orderid, $order [0] ['Customers'] ['parent_id'], 'orders' );
				$language_id = $invoice_dest ['language_id'];
			} else {
				$customer_email = Contacts::getEmails($order [0] ['Customers'] ['customer_id']);
				
				$customer = $order [0] ['Customers'] ['firstname'] . " " . $order [0] ['Customers'] ['lastname'];
				$customer .= ! empty ( $order [0] ['Customers'] ['company'] ) ? " - " . $order [0] ['Customers'] ['company'] : "";
				$fastlink = Fastlinks::findlinks ( $orderid, $order [0] ['Customers'] ['customer_id'], 'orders' );
				$language_id = $order [0] ['Customers'] ['language_id'];
			}

			$email = $order [0] ['Isp'] ['email'];
			
			$bankInfo = Banks::getBankInfo();
			if(!empty($bankInfo['description'])){
				$bank = $bankInfo['description'];
			}
			
			if ( !empty($customURL) ) {
				$url = $customURL;				
			} else {
				if (! empty ( $fastlink [0] ['code'] )) {
					$url = "http://" . $_SERVER ['HTTP_HOST'] . "/index/link/id/" . $fastlink [0] ['code'];
				} else {
					$url = "http://" . $_SERVER ['HTTP_HOST'];
				}
			}	
			
			$date = explode ( "-", $order [0] ['order_date'] );
			
			Shineisp_Commons_Utilities::sendEmailTemplate($customer_email, 'order_new', array(
				 'orderid'    => $order[0]['order_number']
				,'fullname'      => $customer
				,'email'      => $email
				,'bank'       => $bank
				,'url'        => $url
				,':shineisp:' => $order [0] ['Customers']
				,'conditions' => strip_tags(Settings::findbyParam('conditions'))
			), null, null, null, null, $language_id);

			return true;
		}
		return false;
	}
	
	
	/**
	 * zero prefix order_id
	 */
	public static function zeroPrefix($orderId) {
		// Get the administration preferences
		$prefix = Settings::findbyParam('orders_zero_prefix');

		if(!empty($orderId) && is_numeric($prefix)){
			return str_pad($orderId, $prefix, '0', STR_PAD_LEFT);
		}elseif(!empty($orderId) && !is_numeric($prefix)){
			return $orderId;
		}
	}
	
	/**
	 * Format the order id
	 * @param array|object|int $order
	 */
	public static function formatOrderId($order) {
		if ( empty($order) ) {
			return false;
		}
		
		// Check type of $order. Used for backward compatibility
		if ( is_object($order) ) {
			if ( isset($order->{0}) && isset($order->{0}->order_id) ) {
				$orderId = intval($order->{0}->order_id);
			} else if ( isset($order->order_id) ) {
				$orderId = intval($order->order_id);
			}
		} else if ( is_array($order) ) {
			if ( isset($order[0]) && isset($order[0]['order_id']) ) {
				$orderId = intval($order[0]['order_id']);
			} else if ( isset($order['order_id']) ) {
				$orderId = intval($order['order_id']);
			}
		} else {
			$orderId = intval($order);
		}
		
		$orders_zero_prefix = self::zeroPrefix($orderId);

		$rs = Doctrine_Query::create ()->select ( "o.order_id, s.value AS orders_number_format
													, YEAR(o.order_date) AS order_year
													, MONTH(o.order_date) AS order_month
													, DAY(o.order_date) AS order_day
													, o.order_id AS order_id
													, o.*" )
									   ->from('orders o')
									   ->leftJoin('o.Isp isp')
									   ->leftJoin('isp.Settings s')
									   ->leftJoin('s.SettingsParameters sp')
									   ->where('o.order_id = ?', $orderId)
									   ->andWhere('sp.var = "orders_number_format"')
									   ->fetchOne();

		if ( !is_object($rs) || empty($rs) || empty($rs->orders_number_format) ) {
			// fallback to old method
			return $orders_zero_prefix;
		}
								
		// Some shortcuts
		$orders_number_format = $rs->orders_number_format;
		
		// Get all placeholders in orders_number_format
		preg_match_all('/\[([a-zA-Z0-9_]+)\]/', $orders_number_format, $out);
		if ( is_array($out) && isset($out[1]) ) {
			foreach ( $out[1] as $placeholder ) {
				if ( $placeholder == 'order_id' ) {
					$v = $orders_zero_prefix;
				} else if ( $placeholder == 'order_year2' ) {
					$v = substr($rs->order_year,2,2);	
				} else if ( $placeholder == 'RN' ) {
					$v = mt_rand(0,9);
				} else if ( $placeholder == 'RL' ) {
					$v = chr(65 + mt_rand(0, 25));
				} else if ( $placeholder == 'TS' ) {
					$v = time();
				} else {
					$v = '['.$placeholder.']';
					if ( isset($rs->{$placeholder})) {
						$v = $rs->{$placeholder};
					}
				}
				
				$orders_number_format = preg_replace('/\['.$placeholder.'\]/', $v, $orders_number_format, 1);
			}
		}
		
		// Update order_number. This is a fallback for older installations
		$Order = Doctrine_Core::getTable('Orders')->find($orderId);
		$Order->order_number = $orders_number_format;
		$Order->save();
		
		return $orders_number_format;
	}
	
    /**
     * print the order
     * 
     * @param unknown_type $invoiceid
     */
    public static function pdf($order_id, $show = true, $force=false, $path="/documents/orders/") {
    		$taxpercent = "";
    		$currency = Shineisp_Registry::getInstance ()->Zend_Currency;
    		if(!is_numeric($order_id)){
    			return false;
    		}
    		
    		$pdf = new Shineisp_Commons_PdfOrder ( );
    		$translator = Shineisp_Registry::getInstance ()->Zend_Translate;
			$payments = Payments::findbyorderid ( $order_id, null, true );
			$order = self::getAllInfo ( $order_id, null, true );
			
			// Set the name of the file
			$filename = $order[0] ['order_date'] . " - " . $order[0] ['order_id'] . ".pdf";
			
			$database ['header'] ['label'] = $translator->translate('Order No.') . " " . $order[0]['order_number'] . " - " . Shineisp_Commons_Utilities::formatDateOut ($order [0] ['order_date']);
			$database ['columns'] [] = array ("value" => $translator->translate("SKU"), "size" => 40 );
			$database ['columns'] [] = array ("value" => $translator->translate("Description") );
			$database ['columns'] [] = array ("value" => $translator->translate("Qty"), "size" => 30, "align" => "center" );
			$database ['columns'] [] = array ("value" => $translator->translate("Unit"), "size" => 30 );
			$database ['columns'] [] = array ("value" => $translator->translate("Tax Free Price"), "size" => 60, "align" => "right" );
			$database ['columns'] [] = array ("value" => $translator->translate("Discount"), "size" => 60, "align" => "right" );
			$database ['columns'] [] = array ("value" => $translator->translate("Setup fee"), "size" => 60, "align" => "right" );
			$database ['columns'] [] = array ("value" => $translator->translate("Tax %"), "size" => 40, "align" => "center" );
			$database ['columns'] [] = array ("value" => $translator->translate("Total"), "size" => 50, "align" => "right" );
			
			if (isset ( $order [0] )) {
				$orderinfo ['order_number'] = !empty($order[0]['order_number']) ? $order[0]['order_number'] : self::formatOrderId($order[0]['order_id']);
				$orderinfo ['invoice_id'] = "";
				$orderinfo ['date'] = Shineisp_Commons_Utilities::formatDateOut ( $order [0] ['order_date'] );
				
				//if customer comes from reseller
				if ($order [0] ['Customers'] ['parent_id']) {
					$isTaxFree    = Customers::isTaxFree($order [0] ['Customers'] ['parent_id']);
					$isVATFree    = Customers::isVATFree($order [0] ['Customers'] ['parent_id']);
					$invoice_dest = Customers::getAllInfo ( $order [0] ['Customers'] ['parent_id'], 'c.*, a.*' );
					
					$orderinfo ['customer'] ['customer_id'] = $invoice_dest ['customer_id'];
					$orderinfo ['customer'] ['company'] = $invoice_dest ['company'];
					$orderinfo ['customer'] ['firstname'] = $invoice_dest ['firstname'];
					$orderinfo ['customer'] ['lastname'] = $invoice_dest ['lastname'];
					$orderinfo ['customer'] ['vat'] = $invoice_dest ['vat'];
					$orderinfo ['customer'] ['taxpayernumber'] = $invoice_dest ['taxpayernumber'];
					$orderinfo ['customer'] ['email'] = $invoice_dest ['email'];
									
					if (isset ( $invoice_dest ['Addresses'] [0] )) {
						$orderinfo ['customer'] ['address'] = $invoice_dest ['Addresses'] [0] ['address'];
						$orderinfo ['customer'] ['city'] = $invoice_dest ['Addresses'] [0] ['city'];
						$orderinfo ['customer'] ['code'] = $invoice_dest ['Addresses'] [0] ['code'];
						$orderinfo ['customer'] ['country'] = !empty($invoice_dest ['Addresses'] [0] ['Countries'] ['name']) ? $invoice_dest ['Addresses'] [0] ['Countries'] ['name'] : "";
					}
				} else {
					$isTaxFree = Customers::isTaxFree($order [0] ['Customers'] ['customer_id']);
					$isVATFree = Customers::isVATFree($order [0] ['Customers'] ['customer_id']);
					$orderinfo ['customer'] ['customer_id'] = $order [0] ['Customers'] ['customer_id'];
					$orderinfo ['customer'] ['company'] = $order [0] ['Customers'] ['company'];
					$orderinfo ['customer'] ['firstname'] = $order [0] ['Customers'] ['firstname'];
					$orderinfo ['customer'] ['lastname'] = $order [0] ['Customers'] ['lastname'];
					$orderinfo ['customer'] ['vat'] = $order [0] ['Customers'] ['vat'];
					$orderinfo ['customer'] ['taxpayernumber'] = $order [0] ['Customers'] ['taxpayernumber'];
					$orderinfo ['customer'] ['email'] = $order [0] ['Customers'] ['email'];
					
					if (isset ( $order [0] ['Customers'] ['Addresses'] [0] )) {
						$orderinfo ['customer'] ['address'] = $order [0] ['Customers'] ['Addresses'] [0] ['address'];
						$orderinfo ['customer'] ['city'] = $order [0] ['Customers'] ['Addresses'] [0] ['city'];
						$orderinfo ['customer'] ['code'] = $order [0] ['Customers'] ['Addresses'] [0] ['code'];
						$orderinfo ['customer'] ['country'] = $order [0] ['Customers'] ['Addresses'] [0] ['Countries'] ['name'];
					}
				}
				
				if (count ( $payments ) > 0) {
					$orderinfo ['payment_date'] = Shineisp_Commons_Utilities::formatDateOut ( $payments [0] ['paymentdate'] );
					$orderinfo ['payment_mode'] = $payments [0] ['Banks'] ['name'];
					$orderinfo ['payment_description'] = $payments [0] ['description'];
					$orderinfo ['payment_transaction_id'] = $payments [0] ['reference'];
				}
				
				$orderinfo ['invoice_id'] = "";
				
				$orderinfo ['company'] ['name'] = $order [0] ['Isp'] ['company'];
				$orderinfo ['company'] ['manager'] = $order [0] ['Isp'] ['manager'];
				$orderinfo ['company'] ['vat'] = $order [0] ['Isp'] ['vatnumber'];
				$orderinfo ['company'] ['bankname'] = $order [0] ['Isp'] ['bankname'];
				$orderinfo ['company'] ['iban'] = $order [0] ['Isp'] ['iban'];
				$orderinfo ['company'] ['bic'] = $order [0] ['Isp'] ['bic'];
				$orderinfo ['company'] ['address'] = $order [0] ['Isp'] ['address'];
				$orderinfo ['company'] ['zip'] = $order [0] ['Isp'] ['zip'];
				$orderinfo ['company'] ['city'] = $order [0] ['Isp'] ['city'];
				$orderinfo ['company'] ['country'] = $order [0] ['Isp'] ['country'];
				$orderinfo ['company'] ['telephone'] = $order [0] ['Isp'] ['telephone'];
				$orderinfo ['company'] ['fax'] = $order [0] ['Isp'] ['fax'];
				$orderinfo ['company'] ['website'] = $order [0] ['Isp'] ['website'];
				$orderinfo ['company'] ['email'] = $order [0] ['Isp'] ['email'];
				$orderinfo ['company'] ['slogan'] = $order [0] ['Isp'] ['slogan'];
				$orderinfo ['company'] ['custom1'] = $order [0] ['Isp'] ['custom1'];
				$orderinfo ['company'] ['custom2'] = $order [0] ['Isp'] ['custom2'];
				$orderinfo ['company'] ['custom3'] = $order [0] ['Isp'] ['custom3'];
				
				if($order [0] ['status_id'] == Statuses::id("tobepaid", "orders")){ // To be payed
					$orderinfo ['ribbon']['text'] = $translator->translate("To be Paid");
					$orderinfo ['ribbon']['color'] = "#D60000";
					$orderinfo ['ribbon']['border-color'] = "#BD0000";
				}elseif($order [0] ['status_id'] == Statuses::id("complete", "orders")){  // Complete
					$orderinfo ['ribbon']['text'] = $translator->translate("Paid");
					$orderinfo ['ribbon']['color'] = "#009926";
					$orderinfo ['ribbon']['border-color'] = "#00661A";
				}else{
					$orderinfo ['ribbon']['text'] = $translator->translate(Statuses::getLabel($order [0] ['status_id']));
					$orderinfo ['ribbon']['color'] = "#FFCC33";
					$orderinfo ['ribbon']['border-color'] = "#E6AC00";
				}
				
				$orderinfo ['subtotal'] = $order[0] ['total'];
				$orderinfo ['grandtotal'] = $order[0] ['grandtotal'];
				$orderinfo ['vat'] = $order[0] ['vat'];
				$orderinfo ['delivery'] = 0;
				
				$database ['records'] = $orderinfo;
				
				foreach ( $order [0] ['OrdersItems'] as $item ) {
					$price = ($item['price']  * $item['quantity']) + $item['setupfee'];
					 
					$tax = Taxes::getTaxbyProductID($item['product_id']);
					if ($tax['percentage'] > 0) {
						$rowtotal = $price * (100 + $tax['percentage']) / 100;
					} else {
						$rowtotal = $price;
					}
					
					if(!$isTaxFree && !$isVATFree){
						$taxes = Taxes::getTaxbyProductID($item['product_id']);
						if(!empty($taxes['percentage'])){
							$taxpercent = $taxes['percentage'];
						} 
					}
					
					if(!empty($item ['discount'])){
						$item ['discount'] = $item ['discount'] . "%";
					}
					
					$database ['records'] [] = array ($item ['Products']['sku'], $item ['description'], $item ['quantity'], $translator->translate('nr'), $item ['price'], $item ['discount'], $item ['setupfee'], $taxpercent, $rowtotal);
				}
				
				if (isset ( $order [0] )) {
					$pdf->CreatePDF (  $database, $filename, $show, $path, $force);
					
					// Execute a custom event
					self::events()->trigger('orders_pdf_created', "Orders", array('file' => "$path/$filename"));
					
					return $path . $filename;
				}
			}
			return false;
		}
		
	
	/**
	 * Get a orders by id lists 
	 * @param array $ids [1,2,3,4,...,n]
	 * @param string $fields
	 * @return Array
	 */
	public static function get_orders($ids, $fields="*", $orderby=null) {
		return Doctrine_Query::create ()->select($fields)
										->from ( 'Orders o' )
										->leftJoin ( 'o.Customers c' )
										->leftJoin ( 'o.Invoices i' )
										->leftJoin ( 'o.Statuses s' )
										->whereIn( "order_id", $ids)
										->addWhere ( 'c.isp_id = ?', Isp::getCurrentId())
										->orderBy(!empty($orderby) ? $orderby : "")
										->execute ( array (), Doctrine::HYDRATE_ARRAY );
	}
	
	
	/**
	 * List of the last 10 Orders
	 * @return array
	 */
	public static function Last(array $statuses, $limit=10) {
		$translator = Shineisp_Registry::getInstance ()->Zend_Translate;
		$currency   = Shineisp_Registry::getInstance ()->Zend_Currency;
		
		$dq = Doctrine_Query::create ()
								->select ( "order_id, DATE_FORMAT(order_date, '".Settings::getMySQLDateFormat('dateformat')."') as orderdate, i.formatted_number as invoice, 
											CONCAT(c.firstname, ' ', c.lastname, ' ', c.company) as fullname, 
											c.customer_id as customer_id, 
											o.total as total, 
											i.invoice_id as invoice_id, 
											o.grandtotal as grandtotal, 
											s.status as status" )
								->from ( 'Orders o' )							
								->leftJoin ( 'o.Customers c' )
								->leftJoin ( 'o.Invoices i' )
								->leftJoin ( 'o.Statuses s' )
								->addWhere ( 'c.isp_id = ?', Isp::getCurrentId());

        $auth = Zend_Auth::getInstance ();
        if( $auth->hasIdentity () ) {
            $logged_user= $auth->getIdentity ();
            $dq->where( "o.isp_id = ?", $logged_user['isp_id']);
        }
		
		if(is_array($statuses) && !empty($statuses)){
			$dq->whereIn('o.status_id', $statuses);
		}
		
		$dq->orderBy ( 'order_date desc' )->orderBy ( 'order_id desc' )->limit ( $limit );
		$records['data'] = $dq->execute ( null, Doctrine::HYDRATE_ARRAY );
		
		for($i=0;$i<count($records['data']);$i++){
			$records['data'][$i]['total'] = $currency->toCurrency($records['data'][$i]['total'], array('currency' => Settings::findbyParam('currency')));
			$records['data'][$i]['grandtotal'] = $currency->toCurrency($records['data'][$i]['grandtotal'], array('currency' => Settings::findbyParam('currency')));
			$records['data'][$i]['status'] = $translator->translate($records['data'][$i]['status']);
		}

		// adding the index reference 
		$records['index'] = "order_id";
		
		// Create the header table columns
		$records['fields'] = array('order_id' => array('label' => $translator->translate('ID'), 'attributes' => array('class' => 'visible-lg visible-md hidden-xs')), 
		                           'orderdate' => array('label' => $translator->translate('Date'), 'attributes' => array('class' => 'visible-lg visible-md hidden-xs')), 
		                           'invoice' => array('label' => $translator->translate('Invoice'), 'type' => 'link', 'link' => array('idx' => 'invoice_id', 'href' => '/admin/invoices/edit/id/%s'), 'attributes' => array('class' => 'visible-lg visible-md hidden-xs')), 
		                           'fullname' => array('label' => $translator->translate('Customer'), 'type' => 'link', 'link' => array('idx' => 'customer_id', 'href' => '/admin/customers/edit/id/%s')), 
		                           'total' => array('label' => $translator->translate('Total'), 'attributes' => array('class' => 'visible-lg visible-md hidden-xs')), 
		                           'grandtotal' => array('label' => $translator->translate('Grand Total'), 'attributes' => array('class' => 'visible-lg visible-md hidden-xs')), 
		                           'status' => array('label' => $translator->translate('Status')));
		
		return $records;
		
	}
	
	/**
	 * Yield total percentage between periods 
	 * 
	 * @param array $yearsminmax [2010,2013]
	 * @param string $groupby [year, month, quarter]
	 * @return array
	 * 
	 * This is a sample of the array result of this method:
	 * 
	 * [0] => array(21) {
		    ["invoice_id"] => string(3) "532"
		    ["year"] => string(4) "2012"
		    ["gross_grandtotal"] => string(8) "10802.53"
		    ["gross_total"] => string(7) "9102.29"
		    ["gross_vat"] => string(7) "1700.23"
		    ["creditmemo_grandtotal"] => NULL
		    ["creditmemo_total"] => NULL
		    ["creditmemo_vat"] => NULL
		    ["net_grandtotal"] => float(8470.35)
		    ["net_total"] => float(7143.5)
		    ["net_vat"] => float(1326.84)
		    ["month"] => string(1) "4"
		    ["monthname"] => string(5) "April"
		    ["yieldrate"] => string(6) "602,60"
		    ["incdec"] => float(6126.77)
		    ["old"] => array(21) {
		      ["invoice_id"] => string(2) "61"
		      ["year"] => string(4) "2011"
		      ["gross_grandtotal"] => string(7) "2465.52"
		      ["gross_total"] => string(7) "2054.60"
		      ["gross_vat"] => string(6) "410.92"
		      ["creditmemo_grandtotal"] => NULL
		      ["creditmemo_total"] => NULL
		      ["creditmemo_vat"] => NULL
		      ["net_grandtotal"] => float(1242.45)
		      ["net_total"] => float(1016.73)
		      ["net_vat"] => float(225.72)
		      ["month"] => string(1) "4"
		      ["monthname"] => string(5) "April"
		      ["yieldrate"] => int(0)
		      ["incdec"] => int(0)
		      ["old"] => array(0) {
		      }
		      ["costs_total"] => string(7) "1037.87"
		      ["costs_vat"] => string(6) "185.20"
		      ["costs_grandtotal"] => string(7) "1223.07"
		      ["output_vat"] => string(6) "410.92"
		      ["input_vat"] => string(6) "185.20"
		    }
		    ["costs_total"] => string(7) "1958.79"
		    ["costs_vat"] => string(6) "373.39"
		    ["costs_grandtotal"] => string(7) "2332.18"
		    ["output_vat"] => string(7) "1700.23"
		    ["input_vat"] => string(6) "373.39"
		  }
	 * @return ArrayObject
	 */
	public static function incomes(array $years = array(), $groupby="year", $recursive = true) {
		
		$diff = 0;
		
		// Get the year incomes total and subtract the credit memo
		$dq = Doctrine_Query::create ()->select ( "invoice_id, YEAR(i.invoice_date) as year, SUM(o.grandtotal) as gross_grandtotal, SUM(o.total) as gross_total, SUM(o.vat) as gross_vat,
															   SUM(cm.total) as creditmemo_grandtotal, SUM(cm.total_net) as creditmemo_total, SUM(cm.total_vat) as creditmemo_vat,
															   (SUM(o.grandtotal) - ifnull(SUM(cm.total), 0)) as net_grandtotal,
															   (SUM(o.total) - ifnull(SUM(cm.total_net), 0)) as net_total,
															   (SUM(o.vat) - ifnull(SUM(cm.total_vat), 0)) as net_vat" )
													->from ( 'Invoices i' )
													->leftJoin ( 'i.Orders o' )
													->leftJoin ( 'o.Customers c' )
													->leftJoin ( 'i.CreditNotes cm' )
													->where('o.status_id = ? OR o.status_id = ?', array(Statuses::id('paid', 'orders'), Statuses::id('complete', 'orders')))
													->andWhere('c.isp_id = ?', Isp::getCurrentId());
													
													
		// Group by the prefered fields
		if($groupby == "month"){
			$dq->addSelect('MONTH(i.invoice_date) as month');
			$dq->addSelect('MONTHNAME(i.invoice_date) as monthname');
			$dq->groupBy("month, year")->orderBy('year, month');
		}elseif($groupby == "quarter"){
			$dq->addSelect('QUARTER(i.invoice_date) as quarter');
			$dq->groupBy("quarter, year")->orderBy('year, quarter');
		}else{
			$dq->groupBy("year")->orderBy('year');
		}
		
		if(!empty($years[0]) && !empty($years[1])){
			$dq->addWhere('YEAR(i.invoice_date) >= ?', $years[0]);
			$dq->addWhere('YEAR(i.invoice_date) <= ?', $years[1]);
		}elseif(!empty($years[0]) && is_numeric($years[0])){
			$dq->addWhere('YEAR(i.invoice_date) = ?', $years);
		}
		
		$income = $dq->execute ( null, Doctrine::HYDRATE_ARRAY );
		
		for ($i=0; $i<count($income); $i++){
			
			// Yield Percentage
			$income[$i]['yieldrate'] = 0;
			
			// Increment / Decrement
			$income[$i]['incdec'] = 0;
				
			// Before the last year
			$income[$i]['old'] = array();
			
			$income[$i]['costs_total'] = 0;
			$income[$i]['costs_vat'] = 0;
			$income[$i]['costs_grandtotal'] = 0;
			
			if($groupby == "month"){
				// Load all the purchase invoices per month
				$costs = PurchaseInvoices::getSummary($income[$i]['year'], false, false, false, true);
				foreach ($costs as $out){
					if($out['month'] == $income[$i]['month']){
						$income[$i]['costs_total'] = $out['total'];
						$income[$i]['costs_vat'] = $out['vat'];
						$income[$i]['costs_grandtotal'] = $out['grandtotal'];
						
						$income[$i]['output_vat'] = $income[$i]['net_vat'];
						$income[$i]['input_vat'] = $income[$i]['costs_vat'];
						
						$income[$i]['net_total'] = $income[$i]['net_total'] - $income[$i]['costs_total'];
						$income[$i]['net_vat'] = $income[$i]['net_vat'] - $income[$i]['costs_vat'];
						$income[$i]['net_grandtotal'] = $income[$i]['net_grandtotal'] - $income[$i]['costs_grandtotal'];
						break;
					}
				}
			}elseif($groupby == "quarter"){
				// Load all the purchase invoices per quarter
				$costs = PurchaseInvoices::getSummary($income[$i]['year'], false, false, true);
				foreach ($costs as $out){
					if($out['quarter'] == $income[$i]['quarter']){
						$income[$i]['costs_total'] = $out['total'];
						$income[$i]['costs_vat'] = $out['vat'];
						$income[$i]['costs_grandtotal'] = $out['grandtotal'];
						
						$income[$i]['output_vat'] = $income[$i]['net_vat'];
						$income[$i]['input_vat'] = $income[$i]['costs_vat'];
				
						$income[$i]['net_total'] = $income[$i]['net_total'] - $income[$i]['costs_total'];
						$income[$i]['net_vat'] = $income[$i]['net_vat'] - $income[$i]['costs_vat'];
						$income[$i]['net_grandtotal'] = $income[$i]['net_grandtotal'] - $income[$i]['costs_grandtotal'];
						break;
					}
				}
			}else{
				$costs = PurchaseInvoices::getSummary($income[$i]['year'], false, true);
				// Load all the purchase invoices per year
				foreach ($costs as $out){
					if($out['year'] == $income[$i]['year']){
						$income[$i]['costs_total'] = $out['total'];
						$income[$i]['costs_vat'] = $out['vat'];
						$income[$i]['costs_grandtotal'] = $out['grandtotal'];
				
						$income[$i]['output_vat'] = $income[$i]['net_vat'];
						$income[$i]['input_vat'] = $income[$i]['costs_vat'];
						
						$income[$i]['net_total'] = $income[$i]['net_total'] - $income[$i]['costs_total'];
						$income[$i]['net_vat'] = $income[$i]['net_vat'] - $income[$i]['costs_vat'];
						$income[$i]['net_grandtotal'] = $income[$i]['net_grandtotal'] - $income[$i]['costs_grandtotal'];
						break;
					}
				}
			}
			
			// For each Income read the old years values
			foreach ($income as $item){
				
				// If the selected year is before last year 
				if($item['year'] == ($income[$i]['year'] - 1) ){
					
					if($groupby == "month"){
						if($income[$i]['month'] == $item['month']){
							if($income[$i]['net_total'] > 0){
								$diff = $income[$i]['net_total'] - $item['net_total'];
								$percent = $diff / $item['net_total'] * 100;
							}else{
								$percent = 0;
							}
							
							$income[$i]['old'] = $item;
							
							// Assign the yield percentage value
							$income[$i]['yieldrate'] = number_format($percent, 2, ',', '');
							$income[$i]['incdec'] = $diff; // Increase / Decrease
						}
					}elseif($groupby == "quarter"){
						if($income[$i]['quarter'] == $item['quarter']){
							if($income[$i]['net_total'] > 0){
								$diff = $income[$i]['net_total'] - $item['net_total'];
								$percent = $diff / $item['net_total'] * 100;
							}else{
								$percent = 0;
							}
								
							$income[$i]['old'] = $item;
								
							// Assign the yield percentage value
							$income[$i]['yieldrate'] = number_format($percent, 2, ',', '');
							$income[$i]['incdec'] = $diff; // Increase / Decrease
						}
					}else{
						// Calculate the Yield percentage on diff
						if($income[$i]['net_total'] > 0){
							$diff = $income[$i]['net_total'] - $item['net_total'];
							$percent = $diff / $item['net_total'] * 100;
						}else{
							$percent = 0;
						}
						
						$income[$i]['old'] = $item;
						
						// Assign the yield percentage value
						$income[$i]['yieldrate'] = number_format($percent, 2, ',', '');
						$income[$i]['incdec'] = $diff; // Increase / Decrease
					}
				}
			}
		}
		
		return !empty($income[0]) ? $income: array();
	}
	
	/**
	 * Create the array data for the Morris Graph JQuery Tool
	 */
	public static function prepareGraphData($yearsminmax=array(), $groupby="year", $recursive = false){

	    $years  = !empty($yearsminmax) ? $yearsminmax : array();
	    $data   = self::incomes($years, $groupby, $recursive);

	    return self::getDataGraph($data, array(), false);
	    
	}
	
	/**
	 * Morris Data Parser
	 * @param array $data
	 */
	private static function getDataGraph($data, $records=array(), $recursive = false){
	    
	    if(!empty($data)){
    	    foreach($data as $item){
    	        if(isset($item['month'])){
    	            $records[$item['year'] . "-" . $item['month']]['ydata'] = $item['net_total'];
    	        }elseif(isset($item['quarter'])){
    	            $records[$item['year'] . "-" . $item['quarter']]['ydata'] = $item['net_total'];
    	        }else{
    	            $records[$item['year']]['ydata'] = $item['net_total'];
    	        }
        	    
        	    if(!empty($data['old']) && $recursive){
        	        return self::getDataGraph($data['old'], $records, $recursive);
        	    }
    	    }
	    }
	    
	    return $records;
	}
	
	######################################### BULK ACTIONS ############################################
	
	
	/**
	 * massdelete
	 * delete the customer selected 
	 * @param array
	 * @return Boolean
	 */
	public static function bulk_delete($items) {
		if(!empty($items)){
			return self::massdelete($items);
		}
		return false;
	}
		
	/**
	 * export the content in a pdf file
	 * @param array $items
	 */
	public function bulk_export($items) {
		$isp = Isp::getCurrentId();
		$pdf = new Shineisp_Commons_PdfList();
		$translator = Shineisp_Registry::getInstance ()->Zend_Translate;
		
		// Get the records from the order table
		$orders = self::get_orders($items, "order_id, i.number as invoicenum, DATE_FORMAT(order_date, '".Settings::getMySQLDateFormat('dateformat')."') as orderdate, c.company as company, CONCAT(c.firstname, ' ', c.lastname) as fullname, total as total, vat as vat, grandtotal as grandtotal, s.status as status", 'order_date');

		// Create the PDF header
		$grid['headers']['title'] = $translator->translate('Orders List');
		$grid['headers']['subtitle'] = $translator->translate('Order Listing');
		$grid['footer']['text'] = $isp['company'] . " - " . $isp['website'];
		 
		if(!empty($orders[0]))

			// Create the columns of the grid
			$grid ['columns'] [] = array ("value" => $translator->translate('Order'), 'size' => 50);
			$grid ['columns'] [] = array ("value" => $translator->translate('Invoice'), 'size' => 50);
			$grid ['columns'] [] = array ("value" => $translator->translate('Date'), 'size' => 100);
			$grid ['columns'] [] = array ("value" => $translator->translate('Company'));
			$grid ['columns'] [] = array ("value" => $translator->translate('Fullname'));
			$grid ['columns'] [] = array ("value" => $translator->translate('Total'), 'size' => 50);
			$grid ['columns'] [] = array ("value" => $translator->translate('VAT'), 'size' => 50);
			$grid ['columns'] [] = array ("value" => $translator->translate('Grand Total'), 'size' => 50);
			$grid ['columns'] [] = array ("value" => $translator->translate('Status'), 'size' => 100);
			
			// Getting the records values and delete the first column the customer_id field.
			foreach ($orders as $item){
				$values = array_values($item);
				$grid ['records'] [] = $values;
			}
				
			// Create the PDF
			die($pdf->create($grid));
		
		return false;	
	}	

    /**
     * Check if all items of order are completed
     ***/
    public static function checkIfOrderItemsAreCompleted( $orderid ) {
        $records = OrdersItems::getAllDetails( $orderid,"s.code as statuscode", true );
        foreach( $records as $record ) {
            if( $record['statuscode'] != Statuses::id('complete','orders')) {
                return false;
            }
        }
        
        return true;        
    }		

}